10 ORG 100H
20PUTSTR EQU 0BFF1H
30WAITK EQU 0BFCDH
40RPTCHR EQU 0BFEEH
50 CALL CLS
60 LD HL,GREET
70 CALL STRLN
80 LD DE,0000H
90 CALL PUTSTR
100 LD A,2
110 OUT (60H),A
120 LD A,1
130 OUT (74H),A
140 LD A,0
150 OUT (73H),A
160 LD A,1
170 OUT (73H),A
180 LD A,0
190 OUT (73H),A
200 LD A,0DH
210 OUT (70H),A
220 LD A,4EH
230 OUT (71H),A
240 LD A,10H
250 OUT (71H),A
260 LD A,0
270 OUT (63H),A
280 LD A,5
290 OUT (71H),A
300 LD A,14H
310 OUT (63H),A
320 LD HL,SDONE
330 CALL STRLN
340 LD DE,0100H
350 CALL PUTSTR
360LOOP00: IN A,(71H)
370 AND 2
380 CP 2
390 JP Z, RECV
400 CALL WAITK
410 CP 0
420 JP Z,LOOP00
430 PUSH AF
440 LD HL,KEY01
450 CALL BYTE
460 LD HL,KEY00
470 CALL STRLN
480 LD DE,0300H
490 CALL PUTSTR
500 POP AF
510 CP 51H
520 JP Z,THEEND
530 CP 3AH
540 JP Z,THEEND
550 CALL MX2KEY
560 CP 8 ; BS
570 JP Z,THEEND
580 CP 0FFH ; FN KEYS
590 JP Z, LOOP00
600 OUT (72H),A
610 LD HL,KEY03
620 PUSH AF
630 LD (HL),A
670 LD HL,KEY02
680 CALL STRLN
690 LD DE,0400H
700 CALL PUTSTR
710 POP AF
720 CP 13
730 JP NZ,LOOP00
740 LD A,10
750 OUT (72H),A
760 JP LOOP00


1100WAIT: CALL WAITK
1110 CP 0
1120 JP Z,WAIT
1130 RET

1140THEEND: LD A,0
1150 OUT (67H),A
1160 LD HL,BYE
1170 CALL STRLN
1180 LD DE,0400H
1190 CALL PUTSTR
1200 RET

2000CLS: LD A,144
2010 LD (CLSN),A
2020 LD DE,0
2030 LD (CLSX),DE
2040 LD A,32
2050 LD (CHAR),A
2060CLS0: LD A,(CLSN)
2070 LD B,A
2080 LD A,(CHAR)
2090 LD DE,(CLSY)
2100 CALL RPTCHR
2110 RET
2120CLSN: DB 144
2130CLSY: DB 0
2140CLSX: DB 0
2150CHAR: DB 32

3000BYTE: PUSH AF
3010 AND 0F0H
3020 RRCA
3030 RRCA
3040 RRCA
3050 RRCA
3060 CALL NIBBLE
3070 INC HL
3080 POP AF
3090 AND 15
3100 CALL NIBBLE
3110 INC HL
3120 RET
3130NIBBLE: SUB 10
3140 JP M, ZERO9
3150 ADD A, 7
3160ZERO9: ADD A, 58
3170 LD (HL), A
3180 RET

3190STRLN: LD B,0
3200 PUSH HL
3210STRLN0: LD A,(HL)
3220 CP 0
3230 JP Z,STRLN1
3240 INC HL
3250 INC B
3260 JP STRLN0
3270STRLN1: POP HL
3280 RET

3290MX2KEY: LD B,0
3300 LD C,A ; A IS KEY INDEX
3310 LD HL,MATRIX
3320 ADD HL,BC
3330 LD A,(HL)
3340 RET

4000RECV: IN A,(72H)
4010 LD BC,(INDEX)
4020 LD HL,BUFFER
4030 ADD HL,BC
4040 INC BC
4050 LD (INDEX),BC
4060 LD (HL),A
4070 LD HL,KEY03
4080 PUSH AF
4090 LD (HL),A
4100 LD HL,KEY02
4110 CALL STRLN
4120 LD DE,0500H
4130 CALL PUTSTR
4140 POP AF
4150 CP 10
4160 JP NZ,LOOP00
4170 INC HL
4180 LD A,0
4190 LD (HL),A
4200 LD HL,BUFFER
4210 CALL STRLN
4220 LD DE,0300H
4230 CALL PUTSTR
4240 LD BC,0
4250 LD (INDEX),BC
4260 JP LOOP00


5000GREET: DB '11-Pin UART test',0
5010SDONE: DB 'Setup done. Proceed.',0
5020BYE: DB 'Good Bye...',0
5030MATRIX: DB 0,0FFH,'QWERTYUASDFGHJ'
5040 DB 'KZXCVBNM,'
5050 DB 0FFH,0FFH,0FFH,0FFH,9,32,10 ; DOWN
5060 DB 11,14,15,0FFH,'0.=+',13,'L;',0FFH,'123-' ; UP LEFT RIGHT
5070 DB 0FFH,'IO',0FFH,'456*',0FFH,'P',8,0FFH,'789/'
5080 DB ')',0FFH,0FFH,0FFH,0FFH,0FFH,'(',0FFH,0FFH,0FFH,0FFH,0FFH,0FFH,0FFH
5090 DB 0,12,0FFH
5100BUFFER: DEFS 64
5110 DB 0
5120INDEX: DB 0,0
5130KEY00: DB 'Code: &H'
5140KEY01: DB 0,0,0
5150KEY02: DB 'Char: '
5160KEY03: DB 0,0


