10 ORG 100H
20 JP MAIN
30PUTSTR EQU 0BFF1H
40PUTCHR EQU 0BE62H
50WAITK EQU 0BFCDH
60RPTCHR EQU 0BFEEH

70BUFFER: DB 'THIS BE NO TEST BRA!',0
80BUF00: DB '> BUFFER copied to 8000H',0
90BUF01: DB '> 8000H copied to BUFFER',0
100MYPIN: DB 0

110MAIN: LD A,1
120 OUT (60H),A ; 8-BIT PIO
130 LD A,0
140 OUT (61H),A ; ALL OUTPUT
150MAIN03: CALL CLS
160 LD HL,GREET
170 CALL STRLN
180 LD DE,0000H
190 CALL PUTSTR
200 LD HL,GREET0
210 CALL STRLN
220 LD DE,0100H
230 CALL PUTSTR
240MAIN00: CALL WAITK
250 CALL MX2KEY
260 CP 'Q'
270 JP Z,THEEND
280 CP '0'
290 JP M,MAIN00
300 CP '8'
310 JP P,MAIN00
320 LD HL,PIN00
330 LD (HL),A
340 SUB 47
350 CP 1
360 JP Z,MAIN01
370 DEC A
380 LD B,A
390 LD A,1
400MAIN02: RLCA
410 AND 0FEH
420 DJNZ MAIN02
430MAIN01: LD (MYPIN),A
440 LD HL,PIN01
450 CALL BYTE
460 LD HL,PIN
470 CALL STRLN
480 LD DE,0200H
490 CALL PUTSTR
500 LD A,(MYPIN)

510 LD HL,BUFFER
520 CALL STRLN
530 LD DE,0300H
540 CALL PUTSTR

550 LD HL,BUFFER
560 LD DE,8000H
570 CALL STRLN
580 CALL RAMON

590MAIN0: LD A,(HL)
600 CP 65
610 JP M,MAIN1
620 ADD A,32 ; lowercase
630MAIN1: LD (DE),A
640 INC HL
650 INC DE
660 DJNZ MAIN0
670 CALL RAMOFF

680 CALL RAMON
690 LD HL,8000H
700 LD DE,BUFFER
710 CALL STRLN
720MAIN2: LD A,(HL)
730 LD (DE),A
740 INC HL
750 INC DE
760 DJNZ MAIN2
770 CALL RAMOFF

780 LD HL,BUFFER
790 CALL STRLN
800 LD DE,0400H
810 CALL PUTSTR
815 CALL WAITK
820 JP MAIN03

830THEEND: CALL WAITK
840 CALL CLS
850 RET

860CLS: LD B,144
870 LD DE,0
880CLS0: LD A,32
890 CALL RPTCHR
900 RET
910CLLN: LD B,24
920 LD E,0
930 JP CLS0

940RAMON:
950 LD A,(MYPIN)
960 OUT (62H),A
970 DI
980 XOR A
990 OUT (62H),A

1000 LD A,(MYPIN)
1010 OUT (62H),A
1020 IN A,(17H)
1030 LD (V19A),A
1040 XOR A
1050 OUT (62H),A

1060 LD A,(MYPIN)
1070 OUT (62H),A
1080 XOR A
1090 OUT (17H),A ; disable periph. interrupts
1100 OUT (62H),A

1110 LD A,(MYPIN)
1120 OUT (62H),A
1130 IN A, (19H)
1140 LD (V19B),A
1150 XOR A
1160 OUT (62H),A

1170 LD A,(MYPIN)
1180 OUT (62H),A
1190 LD A,(V19B)
1200 LD B, 50H  ; /CEROM2=L,  BANK1=0, BANK0=1
1210 OR B
1220 OUT (19H),A ; enable ext. ram to 0x8000-0xC0000
1230 XOR A
1240 OUT (62H),A
1250 RET

1260RAMOFF: LD A,(V19B)
1270 OUT (19H),A
1280 LD A,(V19A)
1290 OUT (17H),A ; re-enable ROM

1300 LD A,(MYPIN)
1310 OUT (62H),A
1320 EI
1330 XOR A
1340 OUT (62H),A

1350 RET
1360V19A: DB 0
1370V19B: DB 0

1380STRLN: LD B,0
1390 PUSH HL ; preserve HL
1400STRLN0: LD A,(HL)
1410 CP 0
1420 JP Z,STRLN1
1430 INC HL
1440 INC B
1450 JP STRLN0
1460STRLN1: POP HL ; restore HL
1470 RET

1480MX2KEY: LD B,0
1490 LD C,A ; A IS KEY INDEX
1500 LD HL,MATRIX
1510 ADD HL,BC
1520 LD A,(HL)
1530 RET

1540MATRIX: DB 0,0FFH
1550 DB 'QWERTYUASDFGHJKZXCVBNM,'
1560 DB 0FFH,0FFH,0FFH,0FFH,9,32,10,11,14,15 ; LEFT RIGHT UP DOWN
1570 DB 0FFH,'0.=+',13,'L;',0FFH,'123-'
1580 DB 0FFH,'IO',0FFH,'456*',0FFH,'P',8,0FFH,'789/)'
1590 DB 0FFH,0FFH,0FFH,0FFH,'(',0FFH,0FFH,0FFH,0FFH,0FFH,0FFH,0FFH,0FFH
1600 DB 0,12,0FFH

1610GREET: DB 'Hit key to start',0
1620GREET0: DB '0. 1. 2. 3. 4. 5. 6. 7',0

1630BYTE: PUSH AF
1640 AND 0F0H
1650 RRCA
1660 RRCA
1670 RRCA
1680 RRCA
1690 CALL NIBBLE
1700 INC HL
1710 POP AF
1720 AND 15
1730 CALL NIBBLE
1740 INC HL
1750 RET
1760NIBBLE: SUB 10
1770 JP M,ZERO9
1780 ADD A,7
1790ZERO9: ADD A,58
1800 LD (HL),A
1810 RET

1820PIN: DB 'You picked '
1830PIN00: DB 0,', ie 0x'
1840PIN01: DB 0,0,0

