10 ORG 100H
20 JP MAIN
30PUTSTR EQU 0BFF1H
40PUTCHR EQU 0BE62H
50WAITK EQU 0BFCDH
60RPTCHR EQU 0BFEEH

70BUFFER: DB 'THIS BE NO TEST BRA!',0
80BUF00: DB '> BUFFER copied to 8000H',0
90BUF01: DB '> 8000H copied to BUFFER',0
100MYPIN: DB 0

110MAIN: LD A,1
120 OUT (60H),A ; 8-BIT PIO
130 LD A,0
140 OUT (61H),A ; ALL OUTPUT
150MAIN03: CALL CLS
160 LD HL,GREET
170 CALL STRLN
180 LD DE,0000H
190 CALL PUTSTR
200 LD HL,GREET0
210 CALL STRLN
220 LD DE,0100H
230 CALL PUTSTR
240MAIN00: CALL WAITK
250 CALL MX2KEY
260 CP 'Q'
270 JP Z,THEEND
280 CP '0'
290 JP M,MAIN00
300 CP '8'
310 JP P,MAIN00
320 LD HL,PIN00
330 LD (HL),A
340 SUB 47
350 CP 1
360 JP Z,MAIN01
370 DEC A
380 LD B,A
390 LD A,1
400MAIN02: RLCA
410 AND 0FEH
420 DJNZ MAIN02
430MAIN01: LD (MYPIN),A
440 LD HL,PIN01
450 CALL BYTE
460 LD HL,PIN
470 CALL STRLN
480 LD DE,0200H
490 CALL PUTSTR
500 LD A,(MYPIN)

510 LD HL,BUFFER
520 CALL STRLN
530 LD DE,0300H
540 CALL PUTSTR

550 LD HL,BUFFER
560 LD DE,8000H
570 CALL STRLN
580 CALL RAMON

590MAIN0: LD A,(HL)
600 CP 65
610 JP M,MAIN1
620 ADD A,32 ; lowercase
630MAIN1: LD (DE),A
640 INC HL
650 INC DE
660 DJNZ MAIN0
670 CALL RAMOFF

680 CALL RAMON
690 LD HL,8000H
700 LD DE,BUFFER
710 CALL STRLN
720MAIN2: LD A,(HL)
730 LD (DE),A
740 INC HL
750 INC DE
760 DJNZ MAIN2
770 CALL RAMOFF

780 LD HL,BUFFER
790 CALL STRLN
800 LD DE,0400H
810 CALL PUTSTR
820 CALL WAITK
830 JP MAIN03

840THEEND: CALL WAITK
850 CALL CLS
860 RET

870CLS: LD B,144
880 LD DE,0
890CLS0: LD A,32
900 CALL RPTCHR
910 RET
920CLLN: LD B,24
930 LD E,0
940 JP CLS0

950RAMON:
960 LD A,(MYPIN)
970 OUT (62H),A
980 DI
990 XOR A
1000 OUT (62H),A

1010 LD A,(MYPIN)
1020 OUT (62H),A
1030 IN A,(17H)
1040 LD (V19A),A
1050 XOR A
1060 OUT (62H),A

1070 LD A,(MYPIN)
1080 OUT (62H),A
1090 XOR A
1100 OUT (17H),A ; disable periph. interrupts
1110 OUT (62H),A

1120 LD A,(MYPIN)
1130 OUT (62H),A
1140 IN A, (19H)
1150 LD (V19B),A
1160 XOR A
1170 OUT (62H),A

1180 LD A,(MYPIN)
1190 OUT (62H),A
1200 LD A,(V19B)
1210 LD B, 50H  ; /CEROM2=L,  BANK1=0, BANK0=1
1220 OR B
1230 OUT (19H),A ; enable ext. ram to 0x8000-0xC0000
1240 XOR A
1250 OUT (62H),A
1260 RET

1270RAMOFF: LD A,(MYPIN)
1280 OUT (62H),A
1290 LD A,(V19B)
1300 OUT (19H),A
1310 XOR A
1320 OUT (62H),A

1330 LD A,(MYPIN)
1340 OUT (62H),A
1350 LD A,(V19A)
1360 OUT (17H),A ; re-enable ROM
1370 XOR A
1380 OUT (62H),A

1390 LD A,(MYPIN)
1400 OUT (62H),A
1410 EI
1420 XOR A
1430 OUT (62H),A

1440 RET
1450V19A: DB 0
1460V19B: DB 0

1470STRLN: LD B,0
1480 PUSH HL ; preserve HL
1490STRLN0: LD A,(HL)
1500 CP 0
1510 JP Z,STRLN1
1520 INC HL
1530 INC B
1540 JP STRLN0
1550STRLN1: POP HL ; restore HL
1560 RET

1570MX2KEY: LD B,0
1580 LD C,A ; A IS KEY INDEX
1590 LD HL,MATRIX
1600 ADD HL,BC
1610 LD A,(HL)
1620 RET

1630MATRIX: DB 0,0FFH
1640 DB 'QWERTYUASDFGHJKZXCVBNM,'
1650 DB 0FFH,0FFH,0FFH,0FFH,9,32,10,11,14,15 ; LEFT RIGHT UP DOWN
1660 DB 0FFH,'0.=+',13,'L;',0FFH,'123-'
1670 DB 0FFH,'IO',0FFH,'456*',0FFH,'P',8,0FFH,'789/)'
1680 DB 0FFH,0FFH,0FFH,0FFH,'(',0FFH,0FFH,0FFH,0FFH,0FFH,0FFH,0FFH,0FFH
1690 DB 0,12,0FFH

1700GREET: DB 'Hit key to start',0
1710GREET0: DB '0. 1. 2. 3. 4. 5. 6. 7',0

1720BYTE: PUSH AF
1730 AND 0F0H
1740 RRCA
1750 RRCA
1760 RRCA
1770 RRCA
1780 CALL NIBBLE
1790 INC HL
1800 POP AF
1810 AND 15
1820 CALL NIBBLE
1830 INC HL
1840 RET
1850NIBBLE: SUB 10
1860 JP M,ZERO9
1870 ADD A,7
1880ZERO9: ADD A,58
1890 LD (HL),A
1900 RET

1910PIN: DB 'You picked '
1920PIN00: DB 0,', ie 0x'
1930PIN01: DB 0,0,0

