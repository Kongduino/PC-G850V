10 ORG 100H
20 JP MAIN
30PUTSTR EQU 0BFF1H
40PUTCHR EQU 0BE62H
50WAITK EQU 0BFCDH
60RPTCHR EQU 0BFEEH

70BUFFER: DB 'THIS IS NOT A TEST!',0
150BUF00: DB '> BUFFER copied to 8000H',0
160BUF01: DB '> 8000H copied to BUFFER',0

170MAIN: CALL CLS
180 LD HL,BUFFER
190 CALL STRLN
200 LD DE,0
210 CALL PUTSTR

230 LD HL,BUFFER
240 LD DE,8000H
250 CALL STRLN
220 CALL RAMON
260MAIN0: LD A,(HL)
270 CP 65
280 JP M,MAIN1
290 ADD A,32 ; lowercase
300MAIN1: LD (DE),A
310 INC HL
320 INC DE
330 DJNZ MAIN0
340 CALL RAMOFF

350 LD HL,BUF00
360 CALL STRLN
370 LD DE,0100H
380 CALL PUTSTR

390 CALL RAMON
400 LD HL,8000H
410 LD DE,BUFFER
420 CALL STRLN
430MAIN2: LD A,(HL)
440 LD (DE),A
450 INC HL
460 INC DE
470 DJNZ MAIN2
480 CALL RAMOFF

490 LD HL,BUF01
500 CALL STRLN
510 LD DE,0200H
520 CALL PUTSTR

530 LD HL,BUFFER
540 CALL STRLN
550 LD DE,0300H
560 CALL PUTSTR

570 CALL WAITK
580 CALL CLS
590 RET

600CLS: LD B,144
610 LD DE,0
620CLS0: LD A,32
630 CALL RPTCHR
640 RET
650CLLN: LD B,24
660 LD E,0
670 JP CLS0

680RAMON: DI
690 IN A,(17H)
700 LD (V19A),A
710 LD A,0
720 OUT (17H),A ; disable periph. interrupts
730 IN A, (19H)
740 LD (V19B),A
750 LD B, 50H  ; /CEROM2=L,  BANK1=0, BANK0=1
760 OR B
770 OUT (19H),A ; enable ext. ram to 0x8000-0xC0000
780 RET

790RAMOFF: LD A,(V19B)
800 OUT (19H),A
810 LD A,(V19A)
820 OUT (17H),A ; re-enable ROM
830 EI
840 RET
850V19A: DB 0
860V19B: DB 0

870STRLN: LD B,0
880 PUSH HL ; preserve HL
890STRLN0: LD A,(HL)
900 CP 0
910 JP Z,STRLN1
920 INC HL
930 INC B
940 JP STRLN0
950STRLN1: POP HL ; restore HL
960 RET

