10 ORG 100H
20 JP MAIN
30WRASR EQU 0BFAFH
40PUTSTR EQU 0BFF1H
50INKEY EQU 089BEH
60PUTCHR EQU 0BE62H
70INITSR EQU 0871AH
80AOUT EQU 0BD09H
90OPENSR EQU 0BCE8H
100CLOSSR EQU 0BCEBH
110LRDSR EQU 0BD15H
120WAITK EQU 0BFCDH
130WCHRSR EQU 0BFAFH
140WSTSR EQU 0BFB2H
150A2HEX EQU 0F9BDH
160RPTCHR EQU 0BFEEH
170REGOUT EQU 0BD03H

180MAIN: CALL INITSR
190 CALL OPENSR
200 CALL CLS
210 LD HL, GREET
220 CALL STRLN
230 LD DE, 00000H
240 CALL PUTSTR
250 LD HL, GREET
260 CALL WSTSR
270 LD HL,170
280 LD (NUMBER),HL

300MAIN00: CALL CLNUP
310 CALL BC2NUM
320 LD HL,LNNUM
330 CALL STRLN
340 LD DE,0100H
350 CALL PUTSTR
360 LD HL,LNNUM
370 LD BC,11
380 ADD HL,BC
390 CALL WSTSR
400 LD HL,BUFF01 ; hex-encoded
410 CALL LRDSR
420 LD HL,BUFF01
430 LD DE,0400H
440 LD B, 60
450 CALL PUTSTR
460 LD HL,TXT03
470 LD B,6
480 CALL PUTSTR
490 CALL WAIT
500 LD HL,BUFF00 ; hex-decoded
510 LD DE,BUFF01 ; hex-encoded
520 LD B,30
530 CALL ASC2H
540 LD HL,0
550 LD (BSCORE),HL
560 LD (TSCORE),HL
570 LD HL,BCHAR
580 LD (HL),0
590 LD A,0FFH; from 0xFF to 0x01
600 LD (CCHAR),A
610MAIN01: LD B,30
620 LD DE,BUFF00 ; hex-decoded
630 LD HL,0
640 LD (CSCORE),HL
650 LD HL,BUFF01 ; XOR'd string
660 LD A,(CCHAR)
670 LD C,A
680MAIN02: LD A,(DE)
690 XOR C
700 LD (HL),A
710 INC HL
720 INC DE
730 DJNZ MAIN02
740 PUSH HL
750 PUSH DE
760 PUSH BC
770 CALL GRADE ; now rate it
780 LD DE,(CSCORE)
790 LD HL,(BSCORE)
800 SBC HL,DE
810 JP NC,MAIN03 ; LOWER, DON'T CARE
820 LD HL,(CSCORE)
830 LD (BSCORE),HL
840 LD A,(CCHAR)
850 LD (BCHAR),A
860 ; CALL REGOUT
870MAIN03: POP BC
880 POP DE
890 POP HL ; Decrement CCHAR and go
900 LD A,(CCHAR)
910 DEC A
920 LD (CCHAR),A
930 CP 0
940 JP NZ,MAIN01
950 LD HL,BUFFXZ
960 LD BC,(CSCORE)
970 LD A,B
980 CALL BYTE
990 LD BC,(CSCORE)
1000 LD A,C
1010 CALL BYTE
1020 INC HL
1030 LD A,(CCHAR)
1040 LD (HL),A
1050 LD HL,BUFFXY
1060 LD B,14
1070 LD DE,0202H
1080 CALL PUTSTR
1090 LD B,30
1100 LD A,(BCHAR)
1110 LD C,A
1120 LD DE,BUFF00
1130 LD HL,BUFF01
1140MAIN04: LD A,(DE)
1150 XOR C
1160 LD (HL),A
1170 INC HL
1180 INC DE
1190 DJNZ MAIN04
1200 ; string is xored with best char
1210 LD HL,BUFF01
1220 LD B,30
1230 LD DE,0300H
1240 CALL PUTSTR
1250 LD DE,(BSCORE)
1260 LD HL,(TSCORE)
1270 SBC HL,DE
1280 JP NC,MAIN05 ; LOWER, DON'T CARE
1290 LD HL,(BSCORE)
1300 LD (TSCORE),HL
1310 LD A,(BCHAR)
1320 LD (TCHAR),A
1330 LD HL,(NUMBER)
1340 LD (TLINE),HL
1350MAIN05: LD HL,(NUMBER)
1360 INC HL
1370 LD (NUMBER),HL
1380 LD DE,172
1390 SBC HL,DE
1400 JP NZ,MAIN00
1410 LD DE,(BSCORE)
1420 LD HL,(TSCORE)
1430 LD BC,(TLINE)
1440 LD A,(TCHAR)
1450 CALL REGOUT

999 RET

3000BC2NUM: LD HL,LNUM0
3010 LD BC,(NUMBER)
3020 LD A,B
3030 PUSH BC
3040 CALL BYTE
3050 POP BC
3060 LD A,C
3070 CALL BYTE
3080 RET

3090ASC2H: LD A,(DE)
3100 INC DE
3110 CALL HALF
3120 SLA A
3130 SLA A
3140 SLA A
3150 SLA A
3160 PUSH BC
3170 LD B,A
3180 LD A,(DE)
3190 INC DE
3200 CALL HALF
3210 ADD A,B
3220 LD (HL),A
3230 INC HL
3240 POP BC
3250 DJNZ ASC2H
3260 LD (HL),0
3270 RET

3280WAIT: CALL WAITK
3290 CP 0
3300 JP Z,WAIT
3310 RET

3320CLS: LD B, 144
3330 LD DE, 0
3340CLS0: LD A, 32
3350 CALL RPTCHR
3360 RET
3370CLLN: LD B,24
3380 LD E,0
3390 JP CLS0

3400BYTE: PUSH AF
3410 AND 0F0H
3420 RRCA
3430 RRCA
3440 RRCA
3450 RRCA
3460 CALL NIBBLE
3470 INC HL
3480 POP AF
3490 AND 15
3500 CALL NIBBLE
3510 INC HL
3520 RET
3530NIBBLE: SUB 10
3540 JP M,ZERO9
3550 ADD A,7
3560ZERO9: ADD A,58
3570 LD (HL),A
3580 RET

3590STRLN: LD B,0
3600 PUSH HL
3610STRLN0: LD A,(HL)
3620 CP 0
3630 JP Z,STRLN1
3640 INC HL
3650 INC B
3660 JP STRLN0
3670STRLN1: POP HL
3680 RET

3690HALF: SUB 48
3700 CP 10
3710 JP M,HALF9
3720 SUB 7
3730HALF9: RET

3740CLNUP: LD B,192
3750 LD HL,BUFF00
3760CLNUP0: LD (HL),0
3770 INC HL
3780 DJNZ CLNUP0
3790 LD B,192
3800 LD HL,BUFF01
3810CLNUP1: LD (HL),0
3820 INC HL
3830 DJNZ CLNUP1
3840 RET

4000FREQ: DB ' ET.AOSINRHDLC',0
4010GRADE: LD DE,BUFF01 ; XOR'ed string
4200 LD A,30
4210GRADE0: LD (CNTR),A
4220 LD A,(DE)
4230 INC DE
4240 CP ' ' ; BELOW ' ' DON'T BOTHER
4250 JP M,GRADE3
4260 CP 127 ; above 7F DON'T BOTHER
4270 JP P,GRADE3
4280 CP 'a'
4290 JP M,SKIP00
4300 CP 'z'
4310 JP P,SKIP00
4320 ; CALL AOUT
4330 SUB 20H ; CAPITALIZE
4340SKIP00: LD HL,FREQ
4350 LD B,14
4360GRADE1: CP (HL)
4370 JP Z,GRADE2
4380 INC HL
4390 DJNZ GRADE1 ; NO MATCH
4400 JP GRADE3
4410GRADE2: LD HL,(CSCORE)
4420 LD C,B
4430 LD B,0
4440 ADD HL,BC
4450 INC HL
4460 LD (CSCORE),HL
4470GRADE3: LD A,(CNTR)
4520 DEC A
4530 CP 0
4540 JP NZ,GRADE0
4550GRADE4: RET

5000GREET: DB 'Matasano Challenge 4'
5010 DB 13,10,0,0,0
5020LNNUM: DB 'Requesting L0x'
5030LNUM0: DB 0,0,0,0,13,10,0
5040NUMBER: DB 0,0
5050BUFF00: DEFS 96
5060BUFF01: DEFS 96
5070BSCORE: DB 0,0
5080BCHAR: DB 0
5090CSCORE: DB 0,0
5100CCHAR: DB 0
5110TSCORE: DB 0,0
5120TLINE: DB 0,0
5130TCHAR: DB 0
5140TXT03: DB 'Result 0x'
5150TXT03A: DB 0,0,32,0,0,0,0
5160BUFFXX: DB 0,' 0x',0,0,0,0
5170BUFFXY: DB 'Score: '
5170BUFFXZ: DB 0,0,0,0,32,0,0,0
5180CNTR: DB 0

