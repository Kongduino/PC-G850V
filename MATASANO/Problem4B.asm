10 ORG 100H
20 JP MAIN
30WRASR EQU 0BFAFH
40PUTSTR EQU 0BFF1H
50INKEY EQU 089BEH
60PUTCHR EQU 0BE62H
70INITSR EQU 0871AH
80AOUT EQU 0BD09H
90OPENSR EQU 0BCE8H
100CLOSSR EQU 0BCEBH
110LRDSR EQU 0BD15H
120WAITK EQU 0BFCDH
130WCHRSR EQU 0BFAFH
140WSTSR EQU 0BFB2H
150A2HEX EQU 0F9BDH
160RPTCHR EQU 0BFEEH
170REGOUT EQU 0BD03H

200MAIN: CALL CLS
210 LD HL, GREET
220 CALL STRLN
230 LD DE, 00000H
240 CALL PUTSTR
250 LD HL,0
260 LD (NUMBER),HL
270 LD (LNPTR),HL ; initialize ptr

300MAIN00: CALL CLNUP
310 CALL BC2NUM
340 LD HL,SAMPLE
350 LD BC,(LNPTR)
360 ADD HL,BC ; hex-encoded
370 LD (CLINE),HL ; save line pos
380 LD DE,0300H
390 LD B, 60
400 CALL PUTSTR
410 LD HL,TXT03A
420 LD BC,(LNPTR)
430 LD A,C
440 CALL BYTE
450 LD BC,(LNPTR)
460 LD A,B
470 CALL BYTE
480 INC HL
490 LD BC,(CLINE)
500 LD A,C
510 CALL BYTE
520 LD BC,(CLINE)
530 LD A,B
540 CALL BYTE
550 LD HL,LNNUM
560 LD B,15
570 LD DE,0100H
571 CALL PUTSTR
572 LD HL,TXT03
573 LD B,18
580 LD DE,0200H
590 CALL PUTSTR
600 LD HL,BUFF00 ; hex-decoded
610 LD DE,(CLINE) ; hex-encoded
620 LD B,30
630 CALL ASC2H ; hex decode
640 LD HL,(LNPTR)
650 LD BC,60
660 ADD HL,BC
670 LD (LNPTR),HL ; increment pointer by 60
680 LD HL,0
690 LD (BSCORE),HL
700 LD (BLINE),HL
710 LD (TSCORE),HL
720 LD (TLINE),HL
730 LD A,0
740 LD (BCHAR),A ; reset

750 LD A,0FFH; from 0xFF to 0x01
760 LD (CCHAR),A
770MAIN01: LD B,30
780 LD DE,BUFF00 ; hex-decoded
790 LD HL,0
800 LD (CSCORE),HL
810 LD HL,BUFF01 ; XOR'd string
820 LD A,(CCHAR)
830 LD C,A
840MAIN02: LD A,(DE)
850 XOR C
860 LD (HL),A
870 INC HL
880 INC DE
890 DJNZ MAIN02 ; done

900 CALL GRADE ; now rate it
910 LD DE,(CSCORE)
920 LD HL,(BSCORE)
930 SBC HL,DE ; bscore vs cscore
940 JP NC,MAIN03 ; LOWER, DON'T CARE
950 LD HL,(CSCORE)
960 LD (BSCORE),HL
970 LD HL,(CLINE)
980 LD (BLINE),HL
990 LD A,(CCHAR)
1000 LD (BCHAR),A ; Update
1010 ; CALL REGOUT
1020MAIN03: ; Decrement CCHAR and go
1030 LD A,(CCHAR)
1040 DEC A
1050 LD (CCHAR),A
1060 CP 0
1070 JP NZ,MAIN01

1080 LD HL,BUFFXZ
1090 LD BC,(CSCORE)
1100 LD A,B
1110 CALL BYTE
1120 LD BC,(CSCORE)
1130 LD A,C
1140 CALL BYTE
1150 INC HL
1160 LD A,(CCHAR)
1170 LD (HL),A
1180 LD HL,BUFFXY
1190 LD B,14
1200 LD DE,0500H
1210 CALL PUTSTR ; display score

1220 LD B,30
1230 LD A,(BCHAR)
1240 LD C,A
1250 LD DE,BUFF00 ; hex-decoded
1260 LD HL,BUFF01 ; XOR'd version
1270MAIN04: LD A,(DE)
1280 XOR C
1290 LD (HL),A
1300 INC HL
1310 INC DE
1320 DJNZ MAIN04
1330 ; string is xored with best char
1340 ; LD HL,BUFF01
1350 ; LD B,30
1360 ; LD DE,0300H
1370 ; CALL PUTSTR

1380 LD DE,(BSCORE)
1390 LD HL,(TSCORE)
1400 SBC HL,DE ; bscore vs tscore
1410 JP NC,MAIN05 ; LOWER, DON'T CARE
1420 LD HL,(BSCORE)
1430 LD (TSCORE),HL
1440 LD HL,(BLINE)
1450 LD (TLINE),HL
1460 LD A,(BCHAR)
1470 LD (TCHAR),A ; update

1480MAIN05: LD HL,(NUMBER)
1490 INC HL
1500 LD (NUMBER),HL
1510 LD DE,56 ; 56 lines for now
1520 SBC HL,DE
1530 JP NZ,MAIN00 ; the end

1540 LD DE,(CLINE)
1550 LD HL,(TSCORE)
1560 LD BC,(TLINE)
1570 LD A,(TCHAR)
1580 CALL REGOUT

999 RET

3000BC2NUM: LD HL,LNUM0
3010 LD BC,(NUMBER)
3020 LD A,B
3030 PUSH BC
3040 CALL BYTE
3050 POP BC
3060 LD A,C
3070 CALL BYTE
3080 RET

3090ASC2H: LD A,(DE)
3100 INC DE
3110 CALL HALF
3120 SLA A
3130 SLA A
3140 SLA A
3150 SLA A
3160 PUSH BC
3170 LD B,A
3180 LD A,(DE)
3190 INC DE
3200 CALL HALF
3210 ADD A,B
3220 LD (HL),A
3230 INC HL
3240 POP BC
3250 DJNZ ASC2H
3260 LD (HL),0
3270 RET

3280WAIT: CALL WAITK
3290 CP 0
3300 JP Z,WAIT
3310 RET

3320CLS: LD B, 144
3330 LD DE, 0
3340CLS0: LD A, 32
3350 CALL RPTCHR
3360 RET
3370CLLN: LD B,24
3380 LD E,0
3390 JP CLS0

3400BYTE: PUSH AF
3410 AND 0F0H
3420 RRCA
3430 RRCA
3440 RRCA
3450 RRCA
3460 CALL NIBBLE
3470 INC HL
3480 POP AF
3490 AND 15
3500 CALL NIBBLE
3510 INC HL
3520 RET
3530NIBBLE: SUB 10
3540 JP M,ZERO9
3550 ADD A,7
3560ZERO9: ADD A,58
3570 LD (HL),A
3580 RET

3590STRLN: LD B,0
3600 PUSH HL
3610STRLN0: LD A,(HL)
3620 CP 0
3630 JP Z,STRLN1
3640 INC HL
3650 INC B
3660 JP STRLN0
3670STRLN1: POP HL
3680 RET

3690HALF: SUB 48
3700 CP 10
3710 JP M,HALF9
3720 SUB 7
3730HALF9: RET

3740CLNUP: LD B,192
3750 LD HL,BUFF00
3760CLNUP0: LD (HL),0
3770 INC HL
3780 DJNZ CLNUP0
3790 LD B,192
3800 LD HL,BUFF01
3810CLNUP1: LD (HL),0
3820 INC HL
3830 DJNZ CLNUP1
3840 RET

4000FREQ: DB ' ET.AOSINRHDLC',0
4010GRADE: LD DE,BUFF01 ; XOR'ed string
4200 LD A,30
4210GRADE0: LD (CNTR),A
4220 LD A,(DE)
4230 INC DE
4240 CP ' ' ; BELOW ' ' DON'T BOTHER
4250 JP M,GRADE3
4260 CP 127 ; above 7F DON'T BOTHER
4270 JP P,GRADE3
4280 CP 'a'
4290 JP M,SKIP00
4300 CP 'z'
4310 JP P,SKIP00
4320 ; CALL AOUT
4330 SUB 20H ; CAPITALIZE
4340SKIP00: LD HL,FREQ
4350 LD B,14
4360GRADE1: CP (HL)
4370 JP Z,GRADE2
4380 INC HL
4390 DJNZ GRADE1 ; NO MATCH
4400 JP GRADE3
4410GRADE2: LD HL,(CSCORE)
4420 LD C,B
4430 LD B,0
4440 ADD HL,BC
4450 INC HL
4460 LD (CSCORE),HL
4470GRADE3: LD A,(CNTR)
4520 DEC A
4530 CP 0
4540 JP NZ,GRADE0
4550GRADE4: RET

5000GREET: DB 'Matasano Challenge 4'
5010 DB 13,10,0,0,0
5020LNNUM: DB 'Loading L0x'
5030LNUM0: DB 0,0,0,0,13,10,0
5035LNPTR: DB 0,0
5040NUMBER: DB 0,0
5050BUFF00: DEFS 96
5060BUFF01: DEFS 96
5070BSCORE: DB 0,0
5080BCHAR: DB 0
5090BLINE: DB 0,0
5100CSCORE: DB 0,0
5110CCHAR: DB 0
5120CLINE: DB 0,0
5130TSCORE: DB 0,0
5140TLINE: DB 0,0
5150TCHAR: DB 0
5160TXT03: DB 'Result 0x'
5170TXT03A: DB 0,0,0,0,32,0,0,0,0,0,0
5180BUFFXX: DB 0,' 0x',0,0,0,0
5190BUFFXY: DB 'Score: '
5200BUFFXZ: DB 0,0,0,0,32,0,0,0
5210CNTR: DB 0
5220SAMPLE:DB '505746313D4D2E3455290A281EE81D'
5230 DB '50007E1148252528025237715A342A'
5240 DB '1C0A13163E404E40242142061D3418'
5250 DB '5421160220FA031F7A423A08F2E01A'
5260 DB '101D303802F51B0C08EF461259315B'
5270 DB '553823E622A12D565509E23C624139'
5280 DB '0A3D1309E4384C0EED383846545A03'
5290 DB '5A41EE1771513B090A031E15F45159'
5300 DB '2D4944092A1965542507003B231957'
5310 DB '58403E175A0A450C5C38114DE21141'
5320 DB 'EB100FE63A031C4B35EB591845E428'
5330 DB '441C0D5B0037131F5C160A31243619'
5340 DB 'C155EF0D19143E24392507A202581A'
5350 DB '25491B135C27571D5C5B35250F0BEF'
5360 DB '0E1D510556485E39557E044E2CF104'
5370 DB '57523016473F500B1E36370C17591C'
5380 DB '7E5A19250A5E152B46F5130A094CEF'
5390 DB '08E84704EF10197324464B0114017A'
5400 DB '3B56F126390008343D3C400232ED20'
5410 DB '1667211F0B1A1413080202530B08E2'
5420 DB '4912321B61C90A0CF6EF0A0A0C0F17'
5430 DB 'FA62EB385E2616194526701AFF5FE6'
5440 DB '2C57114B0400152D4F2AEB18ED4138'
5450 DB '6C2E3A023A281D1A311EEFE750EBAB'
5460 DB '3A4353282114593B3E36446D2C5E1E'
5470 DB '582E335337022930331F211604576A'
5480 DB '295F3BFAE9271AE8065A3B4417545C'
5490 DB '3E5B0DF11A53351C78530915392D2E'
5500 DB '074A122EE01B17131E4E124E2322A9'
5510 DB '560CE4120E37582B24E1036FE93F30'
5520 DB '3C08290121090EF72F25E4F2203234'
5530 DB '44532D3FE71F34553C7B2726131009'
5540 DB '12E84A3308590357A719E74C4F2133'
5550 DB '690A20031A0B045AF63551325B1219'
5560 DB '0E3D4FE03F56523CF40F29E4353455'
5570 DB '120E3A4F2F26F6A30A2B3E0C5B085A'
5580 DB '57F3315C33E41C0F523426232D0651'
5590 DB '395C1525274E314D0219163B5F181F'
5600 DB '53471622182739E9E25B473D74E1E7'
5610 DB '023D095A3134E62D1366563004120E'
5620 DB '230A06431935391D5E0B5543223A3B'
5630 DB 'ED2B4358F555401E1B3B5C36470D11'
5640 DB '22100330E03B4812E6120F163B1EF6'
5650 DB 'ABEBE6F602545EF9A459E33D334C2A'
5660 DB '463405FAA655563A43532CFE154BEC'
5670 DB '32FE3345EB2C2700340811213E5006'
5680 DB '14241340112B2916017C270A065273'
5690 DB '2EE8121132385A6C020C040E2BE15B'
5700 DB '251119225C573B105D5C0A371C3D42'
5710 DB '1EF23E22377FEE334E0228561B2D15'
5720 DB '2E4C2E373B434B0D0B1B340C300E4B'
5730 DB '195614130EA03C234C292E14530C46'
5740 DB '0D2C3F08560EE32E5A5B6413355215'
5750 DB '384442563E69EC294A0EEF561E3053'
5760 DB '193C100C0B24231C012273E10D2E12'
5770 DB '552723586120020B02E45632265E5F'
5780 DB '2C175A11553D4B0B16025E25341809'
5790 DB '64245B125E5D6E595D1D2A0710580B'
5800 DB '213A175FF30855E4001B305000263F'
5810 DB '5A5C3C5100163CEE00114E3518F33A'
5820 DB '10ED33E65B003012E7131E161D5E2E'
5830 DB '270B4645F358394118330F5A5B241B'
5840 DB '33E80130F45708395457573406422A'
5850 DB '3B0D03E6E5053D0D2D151C083337A2'
5860 DB '551BE2082B1563C4EC224714040012'
5870 DB '4D4B6508041B5A472256093AEA1847'
5880 DB '7B5A4215415D544115415D50154554'
5890 DB '47414C155C46155F4058455C5B523F'
5900 DB '0864EB4935144C501103A718513707'
5910 DB '19301BEC57093A0929EA3F18060E55'
5920 DB '2D395E57143359E80EFFFB13330633'
5930 DB 'EA19E323077B4814571E5A3DE73A1F'
5940 DB '52E73C1D53330846243C422D3E1B37'
5950 DB '4B5209543903E3195C041C251B7C04'
5960 DB '2F3C2C28273A12520B482F18340D56'
5970 DB '5D1FE84735474F4A012E1A13502523'
5980 DB '23340F39064E306A08194D54464752'
5990 DB '2E1443041D5EE81F5A18415E34A45F'
6000 DB '475A392637565757730A0C4A517B28'
6010 DB '21040E1709E028071558021F164C54'
6020 DB '100B2135190505264254005618F511'
6030 DB '52136125370EEF27383E45350118ED'
6040 DB '3947452914E0223F1D040943313C19'
6050 DB '3F295B221E573E1B5723391D090D1F'
6060 DB '2C33141859392B04155E3D4E393B32'
6070 DB '2526EE3E581D1B3D6817374D0C085B'
6080 DB 'C2EA5821200F1B755B2D13130F04E2'
6090 DB '6625EA3A5B1E37144D3E473C24030D'
6100 DB 'EE15025D2019F757305E3F010E2A45'
6110 DB '3A205F1919391E1A04E86D1A350119'
6120 DB '1A5BEB4946180FE0002A031A050B41'
6130 DB 'E5164C58795021E1E45C59E2495C20'
6140 DB '1121394F1E381C3647005B73262505'
6150 DB '14272B55250A49183BE5454BA518EB'
6160 DB '1EE55936102A465D5004371F2E382F'
6170 DB '1D03144F170D2B0EED042EE341EB19'
6180 DB 'EC1014EF3FF1272C3408220A411637'
6190 DB '08140B2E340E505C560C1E4CF82704'
6200 DB '274B341A454A27A0263408292E362C'
6210 DB '201C0401462049523B2D55E5132D54'
6220 DB 'E259032C444B091E2E4920023F1A7C'
6230 DB 'E40908255228E36F0F2424394B3C48'
6240 DB '34130CF8223F23084813E745E00653'
6250 DB '1A1E464B005E0E1EE405413FE22B4E'
6260 DB '4AF201080C0928420C2D491F6E5121'
6270 DB 'E451223B070DEE54244B3EFC470A0E'
6280 DB '771C161F795DF81C22101408465AE7'
6290 DB 'EF0C0604733EE03A20560C1512F217'
6300 DB '2F3A142C4155073A200F04166C5656'
6310 DB '34020A59EA04244FF7413C4BC10858'
6320 DB '240D4752E5FA5A4E1CE255505602E5'
6330 DB '5D4C575E2B59F52B4E0C0A0B464019'


