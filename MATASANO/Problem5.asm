10 ORG 100H
20 JP MAIN
30WRASR EQU 0BFAFH
40PUTSTR EQU 0BFF1H
50INKEY EQU 089BEH
60PUTCHR EQU 0BE62H
70INITSR EQU 0871AH
80AOUT EQU 0BD09H
90OPENSR EQU 0BCE8H
100CLOSSR EQU 0BCEBH
110LRDSR EQU 0BD15H
120WAITK EQU 0BFCDH
130WCHRSR EQU 0BFAFH
140WSTSR EQU 0BFB2H
150A2HEX EQU 0F9BDH
160RPTCHR EQU 0BFEEH
170REGOUT EQU 0BD03H

200MAIN: CALL CLS
210 LD HL,GREET
220 CALL STRLN
230 LD DE,00000H
240 CALL PUTSTR
250 LD HL,SAMPLE
260 CALL STRLN
270 LD A,B
280 LD (LENGTH),A
290 LD DE,KEY
300MAIN00: LD A,(HL)
310 CP 0 ; end of the text
320 JP Z,THEEND
330 LD A,(DE) ; end of KEY
340 CP 0
350 JP NZ,MAIN01
360 LD DE,KEY ; Rotate back to start
370 LD A,(DE)
380MAIN01: LD B,(HL)
390 XOR B
400 LD (HL),A
410 INC HL
420 INC DE
430 JP MAIN00 ; loop
440THEEND: LD A,(LENGTH)
450 LD B,A
460 LD HL,BUFFER
470 LD DE,SAMPLE
480END00: LD A,(DE)
490 INC DE
500 CALL HEXIFY
510 DJNZ END00
520 LD (HL),0
530 LD HL,BUFFER
540 LD B,74
550 LD DE,0100H
560 CALL PUTSTR
570 CALL WAIT
580 INC HL
590 LD B,74
600 LD DE,0100H
610 CALL PUTSTR
620 LD HL,FINALM
630 CALL STRLN
640 LD DE,0500H
650 CALL PUTSTR
660 CALL WAIT
670 CALL CLS
999 RET

3000DEHEX: LD A,(DE)
3010 INC DE
3020 CALL HALF
3030 SLA A
3040 SLA A
3050 SLA A
3060 SLA A
3070 PUSH BC
3080 LD B,A
3090 LD A,(DE)
3100 INC DE
3110 CALL HALF
3120 ADD A,B
3130 LD (HL),A
3140 INC HL
3150 POP BC
3160 DJNZ DEHEX
3170 LD (HL),0
3180 RET

3190WAIT: CALL WAITK
3200 CP 0
3210 JP Z,WAIT
3220 RET

3230CLS: LD B,144
3240 LD DE,0
3250CLS0: LD A,32
3260 CALL RPTCHR
3270 RET
3280CLLN: LD B,24
3290 LD E,0
3300 JP CLS0

3310HEXIFY: PUSH AF
3320 AND 0F0H
3330 RRCA
3340 RRCA
3350 RRCA
3360 RRCA
3370 CALL NIBBLE
3380 INC HL
3390 POP AF
3400 AND 15
3410 CALL NIBBLE
3420 INC HL
3430 RET
3440NIBBLE: SUB 10
3450 JP M,ZERO9
3460 ADD A,7
3470ZERO9: ADD A,58
3480 LD (HL),A
3490 RET

3500STRLN: LD B,0
3510 PUSH HL
3520STRLN0: LD A,(HL)
3530 CP 0
3540 JP Z,STRLN1
3550 INC HL
3560 INC B
3570 JP STRLN0
3580STRLN1: POP HL
3590 RET

3600HALF: SUB 48
3610 CP 10
3620 JP M,HALF9
3630 SUB 7
3640HALF9: RET

5000GREET: DB 'Matasano Challenge 5'
5010 DB 0
5020BUFFER: DEFS 180
5030LENGTH: DB 0
5040POSB: DB 0,0
5050POSS: DB 0,0
5060KEY: DB 'ICE'
5070KEYT: DB 0
5080SAMPLE:DB 'Burning '
5090 DB 39,'em, if you ain'
5100 DB 39
5110 DB 't quick and nimble'
5120 DB 10
5130 DB 'I go crazy '
5140 DB 'when I hear a cymbal'
5150SAMPLX: DB 0
5160MSG00: DB 0,0,' ['
5170MSG01: DB 0,'] ^ '
5180MSG03: DB 0,0,' --> '
5190MSG02: DB 0,0,0
5200FINALM: DB '[correct answer!]',0

