10 ORG 100H
20 JP MAIN
30WRASR EQU 0BFAFH
40PUTSTR EQU 0BFF1H
50INKEY EQU 089BEH
30PUTCHR EQU 0BE62H
70INITSR EQU 0871AH
80AOUT EQU 0BD09H
90OPENSR EQU 0BCE8H
100CLOSSR EQU 0BCEBH
110LRDSR EQU 0BD15H
120WAITK EQU 0BFCDH
130WCHRSR EQU 0BFAFH
140WSTSR EQU 0BFB2H
150A2HEX EQU 0F9BDH
160RPTCHR EQU 0BFEEH

170MAIN: CALL INITSR
180 CALL OPENSR
190 CALL CLS
200 LD HL, GREET
210 CALL STRLN
220 LD A, B
230 LD HL, GREET
240 LD DE, 00000H
250 CALL PUTSTR
260 LD A, B
270 LD HL, GREET
280 CALL WSTSR
290 LD HL,0
300 LD (NUMBER),HL

310MAIN00: CALL CLNUP
315 CALL BC2NUM
320 LD HL,LNNUM
330 CALL STRLN
340 LD DE,0100H
350 CALL PUTSTR
360 LD HL,LNNUM
370 LD BC,11
380 ADD HL,BC
390 CALL WSTSR
400 LD HL,BUFF01 ; hex-encoded
410 CALL LRDSR
420 LD HL,BUFF00 ; hex-decoded
430 LD DE,BUFF01 ; hex-encoded
435 LD B,30
440 CALL ASC2H
490 LD HL,0
500 LD (BSCORE),HL
505 LD (TSCORE),HL
510 LD HL,BCHAR
520 LD (HL),0
530 LD A,0FFH; from 0xFF to 0x01
540 LD (CCHAR),A
550MAIN01: LD B,30
560 LD DE,BUFF00 ; hex-decoded
570 LD HL,0
580 LD (CSCORE),HL
590 LD HL,BUFF01 ; XOR'd string
600 LD A,(CCHAR)
610 LD C,A
620MAIN02: LD A,(DE)
630 XOR C
640 LD (HL),A
650 INC HL
660 INC DE
670 DJNZ MAIN02
680 PUSH HL
690 PUSH DE
700 PUSH BC
710 CALL GRADE ; now rate it
720 LD DE,(CSCORE)
730 LD HL,(BSCORE)
740 SBC HL,DE
750 JP NC,MAIN03 ; LOWER, DON'T CARE
760 LD HL,(CSCORE)
770 LD (BSCORE),HL
780 LD A,(CCHAR)
790 LD (BCHAR),A
800 ; CALL REGOUT
810MAIN03: POP BC
820 POP DE
830 POP HL ; Decrement CCHAR and go
840 LD A,(CCHAR)
850 DEC A
860 LD (CCHAR),A
870 CP 0
880 JP NZ,MAIN01

890 LD B,30
900 LD A,(BCHAR)
910 LD C,A
920 LD DE,BUFF00
930 LD HL,BUFF01
940MAIN04: LD A,(DE)
950 XOR C
960 LD (HL),A
970 INC HL
980 INC DE
990 DJNZ MAIN04
1000 ; string is xored with best char
1260 LD HL,BUFF01
1270 LD B,30
1280 LD DE,0300H
1290 CALL PUTSTR

1300 LD DE,(BSCORE)
1310 LD HL,(TSCORE)
1320 SBC HL,DE
1330 JP NC,MAIN05 ; LOWER, DON'T CARE
1340 LD HL,(BSCORE)
1350 LD (TSCORE),HL
1360 LD HL,(NUMBER)
1370 LD (TLINE),HL
1380MAIN05: LD HL,(NUMBER)
1390 INC HL
1400 LD (NUMBER),HL
1410 LD DE,3
1420 SBC HL,DE
1430 JP NZ,MAIN00
1440 LD HL,(TSCORE)
1450 LD BC,(TLINE)
1460 CALL REGOUT

999 RET

3000BC2NUM: LD HL,LNUM0
3010 LD BC,(NUMBER)
3020 LD A,B
3030 PUSH BC
3040 CALL BYTE
3050 POP BC
3060 LD A,C
3070 CALL BYTE
3080 RET

3090ASC2H: LD A,(DE)
3100 INC DE
3110 CALL HALF
3120 SLA A
3130 SLA A
3140 SLA A
3150 SLA A
3160 PUSH BC
3170 LD B,A
3180 LD A,(DE)
3190 INC DE
3200 CALL HALF
3210 ADD A,B
3220 LD (HL),A
3230 INC HL
3240 POP BC
3250 DJNZ ASC2H
3260 LD (HL),0
3270 RET

3280WAIT: CALL WAITK
3290 CP 0
3300 JP Z,WAIT
3310 RET

3320CLS: LD B, 144
3330 LD DE, 0
3340CLS0: LD A, 32
3350 CALL RPTCHR
3360 RET
3370CLLN: LD B,24
3380 LD E,0
3390 JP CLS0

3400BYTE: PUSH AF
3410 AND 0F0H
3420 RRCA
3430 RRCA
3440 RRCA
3450 RRCA
3460 CALL NIBBLE
3470 INC HL
3480 POP AF
3490 AND 15
3500 CALL NIBBLE
3510 INC HL
3520 RET
3530NIBBLE: SUB 10
3540 JP M,ZERO9
3550 ADD A,7
3560ZERO9: ADD A,58
3570 LD (HL),A
3580 RET

3590STRLN: LD B,0
3600 PUSH HL
3610STRLN0: LD A,(HL)
3620 CP 0
3630 JP Z,STRLN1
3640 INC HL
3650 INC B
3660 JP STRLN0
3670STRLN1: POP HL
3680 RET

3690HALF: SUB 48
3700 CP 10
3710 JP M,HALF9
3720 SUB 7
3730HALF9: RET

3740CLNUP: LD B,192
3750 LD HL,BUFF00
3760CLNUP0: LD (HL),0
3770 INC HL
3780 DJNZ CLNUP0
3790 LD B,192
3800 LD HL,BUFF01
3810CLNUP1: LD (HL),0
3820 INC HL
3830 DJNZ CLNUP1
3840 RET

4000FREQ: DB ' ET.AOSINRHDLC',0
4010GRADE: LD DE,BUFF01 ; XOR'ed string
4200 LD A,30
4210GRADE0: LD (CNTR),A
4220 LD A,(DE)
4230 INC DE
4240 CP ' ' ; BELOW ' ' DON'T BOTHER
4250 JP M,GRADE3
4260 CP 127 ; above 7F DON'T BOTHER
4270 JP P,GRADE3
4280 CP 'a'
4290 JP M,SKIP00
4300 CP 'z'
4310 JP P,SKIP00
4320 ; CALL AOUT
4330 SUB 20H ; CAPITALIZE
4340SKIP00: LD HL,FREQ
4350 LD B,14
4360GRADE1: CP (HL)
4370 JP Z,GRADE2
4380 INC HL
4390 DJNZ GRADE1 ; NO MATCH
4400 JP GRADE3
4410GRADE2: LD HL,(CSCORE)
4420 LD C,B
4430 LD B,0
4440 ADD HL,BC
4450 INC HL
4460 LD (CSCORE),HL
4470GRADE3: LD A,(CNTR)
4520 DEC A
4530 CP 0
4540 JP NZ,GRADE0
4550GRADE4: RET

5000GREET: DB 'Matasano Challenge 4'
5010 DB 13,10,0
5020LNNUM: DB 'Requesting L'
5030LNUM0: DB 0,0,0,0,13,10,0
5040NUMBER: DB 0,0
5050BUFF00: DEFS 96
5060BUFF01: DEFS 96
5070BSCORE: DB 0,0
5080BCHAR: DB 0
5090CSCORE: DB 0,0
5100CCHAR: DB 0
5110TSCORE: DB 0,0
5120TLINE: DB 0,0
5130TXT03: DB 'Result 0x'
5140TXT03A: DB 0,0,32,0,0,0,0
5150BUFFXX: DB 0,' 0x',0,0,0,0
5160BUFFXY: DB 'Score: ',0,0,0,0,0,0,0
5170CNTR: DB 0

