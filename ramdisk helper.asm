10 ORG 100H
20 JP MAIN
30REGOUT EQU 0BD03H
40PUTSTR EQU 0BFF1H
50INKEY EQU 0BE53H
60PUTCHR EQU 0BE62H
70WAITK EQU 0BFCDH
80RPTCHR EQU 0BFEEH
90GPF EQU 0BFD0H
100LDPSTR EQU 0BD00H

110PSN: DB 0
120ADDR: DW 0
130RAMBUF: DEFS 128
135TEMP: DW 0

140MAIN: XOR A
150 LD (PSN),A
160 CALL CLS
170 LD HL,GREET
180 LD D,0 ; Y axis
190 CALL PUTBNR
200 LD HL,END01
210 LD A,'*'
220 LD (HL),A
230 INC A
240 LD (HL),A
250 INC A
260 LD (HL),A
270 INC A
280 LD (HL),A
290 LD HL,END00
300 LD D,2
310 CALL PUTBNR
320MAIN00: CALL WAITK
330 CP 1
340 JP Z,THEEND
350 CP 50H
360 JP Z,THEEND
370 CP 51H
380 JP Z,THEEND
390 CALL MX2KEY
400 CP 'Q' ;quit
410 JP Z,THEEND
420 CP '0'
430 JP M,MAIN00
440 CP 'G'
450 JP P,MAIN00
460 CP ':'
470 JP M,MAIN01
480 CP 'A'
490 JP M,MAIN00
500MAIN01: PUSH AF
510 LD HL,END01
520 LD A,(PSN)
530 CP 0
540 JP Z,MAIN02
550 LD C,A
560 LD B,0
570 ADD HL,BC
580MAIN02: POP AF
590 LD (HL),A
600 LD HL,END00
610 LD D,2
620 CALL PUTBNR
630 LD A,(PSN)
640 INC A
650 LD (PSN),A
660 CP 4
670 JP NZ,MAIN00

679 ; test if I got it right
680 LD HL,END01
690 CALL HEX2N
700 LD HL,ADDR
710 INC HL
720 LD (HL),A
730 LD HL,END01
740 INC HL
750 INC HL
760 CALL HEX2N
770 LD HL,ADDR
780 LD (HL),A
790 LD DE,ADDR
800 INC DE
810 LD HL,END01
820 LD A,(DE)
830 CALL BYTE
840 DEC DE
850 LD A,(DE)
860 CALL BYTE
870 LD HL,END00
880 LD D,3
890 CALL PUTBNR
891 ; this should print the same as above

900 LD HL,(ADDR)
920 LD BC,100H ; OFFSET
930 XOR A ; CLEAR C FLAG
940 SBC HL,BC
950 LD (ADDR),HL

960 LD DE,(ADDR)
970 LD HL,END01
980 LD A,E
990 CALL BYTE
1000 LD A,D
1010 CALL BYTE
1020 LD D,5
1030 CALL PUTBNR
1031 CALL WAITK

1040 LD DE,8000H ; START AT 8000H
1050 LD HL,00FFH
1060 LD (TEMP),HL
1070 CALL RAMON
1080MAIN04: LD HL,(TEMP)
1090 INC HL ; START AT 0100H
1100 LD (TEMP),HL
1110 LD A,(HL)
1120 LD (DE),A
1130 INC HL
1140 INC DE
1150 LD HL,(ADDR)
1160 XOR A ; CLEAR C FLAG
1170 LD BC,1
1180 SBC HL,BC
1190 LD (ADDR),HL
1200 LD A,L
1210 CP 0
1220 JP NZ,MAIN04
1230 LD A,H
1240 CP 0
1250 JP NZ,MAIN04
1270MAIN03: CALL RAMOFF

1290 CALL WAITK
1300THEEND: RET

5000CLS: LD B,144
5010 LD DE,0
5020CLS0: LD A,32
5030 CALL RPTCHR
5040 RET
5050CLLN: LD B,24
5060 LD E,0
5070 JP CLS0

5080BYTE: PUSH AF
5090 AND 0F0H
5100 RRCA
5110 RRCA
5120 RRCA
5130 RRCA
5140 CALL NIBBLE
5150 INC HL
5160 POP AF
5170 AND 15
5180 CALL NIBBLE
5190 INC HL
5200 RET
5210NIBBLE: SUB 10
5220 JP M,ZERO9
5230 ADD A,7
5240ZERO9: ADD A,58
5250 LD (HL),A
5260 RET

5270STRLN: LD B,0
5280 PUSH HL ;preserve HL
5290STRLN0: LD A,(HL)
5300 CP 0
5310 JP Z,STRLN1
5320 INC HL
5330 INC B
5340 JP STRLN0
5350STRLN1: POP HL ;restore HL
5360 RET

5370PUTBNR: CALL STRLN
5380 LD A,24
5390 SUB B
5400 RRCA
5410 LD E,A
5420 CALL PUTSTR
5430 RET

5440MX2KEY: LD B,0
5450 LD C,A ;A IS KEY INDEX
5460 LD HL,MATRIX
5470 ADD HL,BC
5480 LD A,(HL)
5490 RET

5500HEX2N: LD A,(HL)
5510 CALL HEX1
5520 ADD A,A
5530 ADD A,A
5540 ADD A,A
5550 ADD A,A
5560 LD B,A
5570 INC HL
5580 LD A,(HL)
5590 CALL HEX1
5600 OR B
5610 RET

5620HEX1: SUB '0'
5630 CP 10
5640 RET C
5650 SUB 7 ;'A'-'0'-10
5660 RET

5670MATRIX: DB 0,0FFH
5680 DB 'QWERTYUASDFGHJKZXCVBNM,'
5690 DB 0FFH,0FFH,0FFH,0FFH,9,32,10,11,14,15 ;LEFT RIGHT UP DOWN
5700 DB 0FFH,'0.=+',13,'L;',0FFH,'123-'
5710 DB 0FFH,'IO',0FFH,'456*',0FFH,'P',8,0FFH,'789/)'
5720 DB 0FFH,0FFH,0FFH,0FFH,'(',0FFH,0FFH,0FFH,0FFH,0FFH,0FFH,0FFH,0FFH
5730 DB 0,12,0FFH

5740RAMON: ;DI
5750 IN A,(17H)
5760 LD (V19A),A
5770 LD A,0
5780 OUT (17H),A ;disable periph. interrupts
5790 IN A, (19H)
5800 LD (V19B),A
5810 LD B, 50H ;/CEROM2=L,  BANK1=0, BANK0=1
5820 OR B
5830 OUT (19H),A ;enable ext. ram to 0x8000-0xC0000
5840 RET

5850RAMOFF: LD A,(V19B)
5860 OUT (19H),A
5870 LD A,(V19A)
5880 OUT (17H),A ;re-enable ROM
5890 ;EI
5900 RET
5910V19A: DB 0
5920V19B: DB 0

5930BANK2R: LD HL,(ADDR)
5940 LD DE,RAMBUF
5950 LD B,128
5960 CALL RAMON
5970LOOP00: LD A,(HL)
5980 LD (DE),A
5990 INC HL
6000 INC DE
6010 DJNZ LOOP00
6020 CALL RAMOFF

6030R2BANK: LD HL,RAMBUF
6040 LD DE,(ADDR)
6050 LD B,128
6060 CALL RAMON
6070LOOP01: LD A,(HL)
6080 LD (DE),A
6090 INC HL
6100 INC DE
6110 DJNZ LOOP01
6120 CALL RAMOFF

6130GREET: DB '- RAM Disk -',0
6140LIST00: DB 'FILENAME: 0x0100-0x'
6150LIST01: DB 0,0,0,0,0
6160END00: DB '0x0100 - 0x'
6170END01: DB '____',0

