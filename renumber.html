<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>renumber</title>
  <meta name="generator" content="BBEdit 13.1" />
</head>
<body>
  <div style="float: left;">
    <h3><label for="text2renumber">Code to renumber:</label></h3>
    <textarea id="text2renumber" name="text2renumber" rows="36" cols="60" ></textarea><br />
    <div id="EQUs" style="width: 500px;">
    </div>
  </div>
  <div style="float: left; padding-left: 20px;padding-top: 10px;">
    <h3><label for="startLine">Start Line:</label></h3>
    <input type="text" id="startLine" style="width: 50px;" value="10">
    <h3><label for="increment">Increment:</label></h3>
    <input type="text" id="increment" style="width: 50px;" value="10">
    <h3><label for="labelColor">Labels:</label></h3>
    <input type="color" id="labelColor" value="#a52a2a" style="width:85%;">
    <h3><label for="numColor">Numbers:</label></h3>
    <input type="color" id="numColor" value="#e69500" style="width:85%;">
    <h3><label for="numColor">Strings:</label></h3>
    <input type="color" id="strColor" value="#800080" style="width:85%;">
    <h3><label for="numColor">Comments:</label></h3>
    <input type="color" id="comColor" value="#808080" style="width:85%;"><br /><br />
    <h3><label for="kwdColor">Keywords:</label></h3>
    <input type="color" id="kwdColor" value="#0000ff" style="width:85%;"><br /><br />
    <input type="button" value="go" onclick="renumber()"><br /><br />
  </div>
  <div style="float: left; padding-left: 20px;padding-top: 50px; height: 600px;">
    <div style="width: 400px; height: 600px; overflow: scroll;">
      <code contenteditable="true" id="final" style="height: 600px;"></code>
    </div>
  </div>

<script type="text/javascript">
var busy=false;
var opcodes=[];
opcodes.push("ADC");
opcodes.push("ADD");
opcodes.push("BIT");
opcodes.push("CALL");
opcodes.push("CCF");
opcodes.push("CPD");
opcodes.push("CPDR");
opcodes.push("CPI");
opcodes.push("CPIR");
opcodes.push("CPL");
opcodes.push("DAA");
opcodes.push("DEC");
opcodes.push("DJNZ");
opcodes.push("EXX");
opcodes.push("HALT");
opcodes.push("IN");
opcodes.push("INC");
opcodes.push("IND");
opcodes.push("INDR");
opcodes.push("INI");
opcodes.push("INIR");
opcodes.push("JP");
opcodes.push("JR");
opcodes.push("LD");
opcodes.push("LDD");
opcodes.push("LDDR");
opcodes.push("LDI");
opcodes.push("LDIR");
opcodes.push("NEG");
opcodes.push("NOP");
opcodes.push("OTDR");
opcodes.push("OTIR");
opcodes.push("OUT");
opcodes.push("OUTD");
opcodes.push("OUTI");
opcodes.push("POP");
opcodes.push("PUSH");
opcodes.push("RES");
opcodes.push("RET");
opcodes.push("RETI");
opcodes.push("RETN");
opcodes.push("RL");
opcodes.push("RLA");
opcodes.push("RLC");
opcodes.push("RLCA");
opcodes.push("RLD");
opcodes.push("RR");
opcodes.push("RRA");
opcodes.push("RRC");
opcodes.push("RRCA");
opcodes.push("RRD");
opcodes.push("RST");
opcodes.push("SBC");
opcodes.push("SCF");
opcodes.push("SET");
opcodes.push("SLA");
opcodes.push("SLL");
opcodes.push("SRA");
opcodes.push("SRL");
var opl=opcodes.length;

var EQUs={};
EQUs["PUTCHR"]="0BE62H";
EQUs["PUTSTR"]="0BFF1H";
EQUs["INITSR"]="0871AH";
EQUs["AOUT"]="0BD09H";
EQUs["WAITK"]="0BFCDH";
EQUs["WSTSR"]="0BFB2H";
EQUs["ROLLUP"]="084F7H";
EQUs["OPENSR"]="0BCE8H";
EQUs["CLOSSR"]="0BCEBH";
EQUs["LRDSR"]="0BD15H";
EQUs["RDBSR0"]="0BCDFH";
EQUs["RDBSR1"]="0BCE2H";
EQUs["RDBSR2"]="0BCE5H";
EQUs["ADDCRLF"]="0BCEEH";
EQUs["GETCHR"]="0BCFDH";
EQUs["LDPSTR"]="0BD00H";
EQUs["REGOUT"]="0BD03H";
EQUs["HLOUT"]="0BD0FH";
EQUs["PWROFF"]="0BD2DH";
EQUs["INKEY"]="0BE53H";
EQUs["INSLN"]="0BE65H";
EQUs["WRASR"]="0BFAFH";
EQUs["WPIXELS"]="0BFD0H";
EQUs["RPTCHR"]="0BFEEH";
EQUs["PWROFF"]="0C110H";

var s="";
for (x in EQUs) {
  if(EQUs.hasOwnProperty(x)) {
    s=s+"<div style='float: left;'>";
    s=s+"<input type='checkbox' id='equ"+x+"' name='"+x+"' value='"+EQUs[x]+"' onChange='cbChanged(\"equ"+x+"\")';>";
    s=s+"<label for='equ"+x+"'> "+x+" = "+EQUs[x]+"</label>&nbsp;";
    s=s+"</div>";
  }
}
document.getElementById('EQUs').innerHTML=s;

function renumber() {
  var t=document.getElementById('text2renumber');
  var f=document.getElementById('final');
  var lines=t.value.split('\n');
  var fixed=[];
  var i, j=lines.length-1; // last line is the stop char
  var lineCount=document.getElementById('startLine').value*1;
  var increment=document.getElementById('increment').value*1;
  var labels=[];
  var lc=document.getElementById('labelColor').value;
  var nc=document.getElementById('numColor').value;
  var cc=document.getElementById('comColor').value;
  var sc=document.getElementById('strColor').value;
  var kc=document.getElementById('kwdColor').value;
  for (i=0; i<j; i++) {
    var s=lines[i];
    s=s.replace(/^\d+/,"").trim();
    if(s!="") {
      if(s.search(/^\w+:/)==0) lines[i]=lineCount.toString()+s;
      else if(s.search(/^\*\w+:/)==0) lines[i]=lineCount.toString()+s;
      else if(s.search(/^\w+ EQU /)==0) lines[i]=lineCount.toString()+s;
      else lines[i]=lineCount.toString()+" "+s;
      var ss=lines[i].replace(/^(\d+)([A-Z]\w+):/, "$1<span style=\"color: "+lc+"\">$2</span>:");
      ss=lines[i].replace(/^(\d+)([A-Z]\w+) EQU/, "$1<span style=\"color: "+lc+"\">$2</span> EQU");
      ss=ss.replace(/(\d+)/, "<span style=\"color: "+nc+"\">$1</span>");
      ss=ss.replace(/(;.+)/, "<span style=\"color: "+cc+"\">$1</span>");
      ss=ss.replace(/(0[0-9A-F]+H)/, "<span style=\"color: "+nc+"\">$1</span>");
      ss=ss.replace(/('.+')/, "<span style=\"color: "+sc+"\">$1</span>");
      fixed.push(ss)
      lineCount+=increment;
    }
  }
  t.value=lines.join('\n');
  ss=fixed.join('<br />\n');
  s=t.value;
  console.log("> ",s);
  x=s.matchAll(/\d+(\w+)(:| EQU)/g);
  console.log(x);
  for (match of x) {
    labels.push(match[1]);
    console.log(">",match[1]);
  }
  k=labels.length;
  for (n=0; n<k; n++) {
    var rx=RegExp("("+labels[n]+")(:|<br)","g");
    console.log("rx",rx);
    ss=ss.replace(rx, "<span style='color: "+lc+"'>$1</span>\$2");
  }
  for(i=0; i<opl; i++) {
    s=opcodes[i];
    rx=RegExp("([^\\w>])([A-Z]\\w+)", "g");
    console.log(rx);
    ss=ss.replace(rx, "$1<span style=\"color: "+kc+"\">$2</span>");
  }
  f.innerHTML=ss+"<br /><br /><br />";
}
var target=document.querySelector('#text2renumber');
target.addEventListener('paste', (event) => {
  busy=true;
  console.log("You posted text");
  var paste = (event.clipboardData || window.clipboardData).getData('text').trim()+"\n\n";
  var lns=paste.split("\n");
  lns=lns[0].replace(/^(\d+).+/g,"$1");
  lns=lns*1;
  if(lns>0) startLine.value=lns;
  for (x in EQUs) {
    if(EQUs.hasOwnProperty(x)) {
      rx=RegExp("\\d+"+x+" EQU "+EQUs[x],"g");
      // console.log(rx);
      if(paste.search(rx)>-1) {
        document.getElementById('equ'+x).checked=true;
      } else {
        document.getElementById('equ'+x).checked=false;
      }
    }
  }
  busy=false;
});
document.getElementById('text2renumber').focus();

function cbChanged(x) {
  if(busy==true) return;
  console.log(x, 'cbChanged');
  var cb=document.getElementById(x);
  var n = cb.name;
  var v=cb.value;
  var rp="1"+n+" EQU "+v+"\n";
  if(cb.checked) {
    var ss=document.getElementById('text2renumber').value.replace(v, n);
    var x=ss.search(/\d+(\w+)(:| EQU)/g);
    ss=ss.substr(0, x-1)+"\n"+rp+ss.substr(x+1);
    document.getElementById('text2renumber').value=ss;
  } else {
    var rx=RegExp("\\d+"+n+" EQU "+v+"\n", "g");
    console.log(rx);
    document.getElementById('text2renumber').value=document.getElementById('text2renumber').value.replace(rx, "");
  }
  renumber();
}
</script>
</body>
</html>
