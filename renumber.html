<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>renumber</title>
  <meta name="generator" content="BBEdit 13.1" />
</head>
<body>
  <div style="float: left;">
    <h3><label for="text2renumber">Code to renumber:</label></h3>
    <textarea id="text2renumber" name="text2renumber" rows="36" cols="60" ></textarea><br />
    <div id="EQUs" style="width: 500px;">
    </div>
  </div>
  <div style="float: left; padding-left: 20px;padding-top: 10px;">
    <h3><label for="startLine">Start Line:</label></h3>
    <input type="text" id="startLine" style="width: 50px;" value="10" onfocus="this.select();">
    <h3><label for="increment">Increment:</label></h3>
    <input type="text" id="increment" style="width: 50px;" value="10" onfocus="this.select();">
    <h3><label for="labelColor">Labels:</label></h3>
    <input type="color" id="labelColor" value="#a52a2a" style="width:85%;">
    <h3><label for="numColor">Numbers:</label></h3>
    <input type="color" id="numColor" value="#e69500" style="width:85%;">
    <h3><label for="numColor">Strings:</label></h3>
    <input type="color" id="strColor" value="#800080" style="width:85%;">
    <h3><label for="numColor">Comments:</label></h3>
    <input type="color" id="comColor" value="#808080" style="width:85%;"><br /><br />
    <h3><label for="kwdColor">Keywords:</label></h3>
    <input type="color" id="kwdColor" value="#0000ff" style="width:85%;"><br /><br />
    <input type="button" value="go" onclick="renumber()"><br /><br />
  </div>
  <div style="float: left; padding-left: 20px;padding-top: 50px; height: 90%;">
    <div style="width: 400px; height: 700px; overflow: scroll;">
      <code contenteditable="true" id="final" style="height: 700px;"></code>
    </div>
  </div>
<input type="file" id="files" name="files[]" multiple />
<output id="list"></output>

<script>
function handleFileSelect(evt) {
  var files = evt.target.files; // FileList object
  // files is a FileList of File objects. List some properties.
  var output = [];
  for (var i = 0, f; f = files[i]; i++) {
    output.push('<li><strong>', escape(f.name), '</strong> (', f.type || 'n/a', ') - ',
    f.size, ' bytes, last modified: ',
    f.lastModifiedDate ? f.lastModifiedDate.toLocaleDateString() : 'n/a',
    '</li>');
  }
  document.getElementById('list').innerHTML = '<ul>' + output.join('') + '</ul>';
}
document.getElementById('files').addEventListener('change', handleFileSelect, false);

function readBlob(opt_startByte, opt_stopByte) {
  var files = document.getElementById('files').files;
  if (!files.length) {
    alert('Please select a file!');
    return;
  }
  var file = files[0];
  var start = parseInt(opt_startByte) || 0;
  var stop = parseInt(opt_stopByte) || file.size - 1;
  var reader = new FileReader();
  // If we use onloadend, we need to check the readyState.
  reader.onloadend = function(evt) {
    if (evt.target.readyState == FileReader.DONE) {
      // DONE == 2
      var t=evt.target.result.split('');
      j=t.length;
      for(i=0; i<j;i++) {
        s=t[i].charCodeAt(0).toString(16);
        if(s.length==1) s="0"+s;
        t[i]=s;
      }
      console.log('Read bytes: ', start + 1, ' - ', stop + 1, ' of ', file.size, ' byte file');
      console.log(t);
    }
  };
  var blob = file.slice(start, stop + 1);
  reader.readAsBinaryString(blob);
}
</script>

<script type="text/javascript">
if (window.File && window.FileReader && window.FileList && window.Blob) {
  console.log('The File APIs are supported in this browser.');
} else {
  console.log('The File APIs are not fully supported in this browser.');
}

var busy=false;
var opcodes=[];
opcodes.push("ADC");
opcodes.push("ADD");
opcodes.push("BIT");
opcodes.push("CALL");
opcodes.push("CCF");
opcodes.push("CPD");
opcodes.push("CPDR");
opcodes.push("CPI");
opcodes.push("CPIR");
opcodes.push("CPL");
opcodes.push("DAA");
opcodes.push("DEC");
opcodes.push("DJNZ");
opcodes.push("EXX");
opcodes.push("HALT");
opcodes.push("IN");
opcodes.push("INC");
opcodes.push("IND");
opcodes.push("INDR");
opcodes.push("INI");
opcodes.push("INIR");
opcodes.push("JP");
opcodes.push("JR");
opcodes.push("LD");
opcodes.push("LDD");
opcodes.push("LDDR");
opcodes.push("LDI");
opcodes.push("LDIR");
opcodes.push("NEG");
opcodes.push("NOP");
opcodes.push("OTDR");
opcodes.push("OTIR");
opcodes.push("OUT");
opcodes.push("OUTD");
opcodes.push("OUTI");
opcodes.push("POP");
opcodes.push("PUSH");
opcodes.push("RES");
opcodes.push("RET");
opcodes.push("RETI");
opcodes.push("RETN");
opcodes.push("RL");
opcodes.push("RLA");
opcodes.push("RLC");
opcodes.push("RLCA");
opcodes.push("RLD");
opcodes.push("RR");
opcodes.push("RRA");
opcodes.push("RRC");
opcodes.push("RRCA");
opcodes.push("RRD");
opcodes.push("RST");
opcodes.push("SBC");
opcodes.push("SCF");
opcodes.push("SET");
opcodes.push("SLA");
opcodes.push("SLL");
opcodes.push("SRA");
opcodes.push("SRL");
var opl=opcodes.length;

var EQUs={};
EQUs["PUTCHR"]="0BE62H";
EQUs["RPTCHR"]="0BFEEH";
EQUs["GETCHR"]="0BCFDH";
EQUs["WAITK"]="0BFCDH";
EQUs["INKEY"]="0BE53H";
EQUs["ADCRLF"]="0BCEEH";
EQUs["PUTSTR"]="0BFF1H";
EQUs["INSLN"]="0BE65H";
EQUs["AOUT"]="0BD09H";
EQUs["A2HEX"]="0F9BDH";
EQUs["HLOUT"]="0BD0FH";
EQUs["REGOUT"]="0BD03H";
EQUs["ROLLUP"]="084F7H";
EQUs["INITSR"]="0871AH";
EQUs["WRASR"]="0BFAFH";
EQUs["OPENSR"]="0BCE8H";
EQUs["CLOSSR"]="0BCEBH";
EQUs["LRDSR"]="0BD15H";
EQUs["WSTSR"]="0BFB2H";
EQUs["RDBSR0"]="0BCDFH";
EQUs["RDBSR1"]="0BCE2H";
EQUs["RDBSR2"]="0BCE5H";
EQUs["LDPSTR"]="0BD00H";
EQUs["WPIXELS"]="0BFD0H";
EQUs["PWRON"]="0BD2DH";
EQUs["PWROFF"]="0C110H";

var s="";
for (x in EQUs) {
  if(EQUs.hasOwnProperty(x)) {
    s=s+"<div style='float: left;'>";
    s=s+"<input type='checkbox' id='equ"+x+"' name='"+x+"' value='"+EQUs[x]+"' onChange='cbChanged(\"equ"+x+"\")';>";
    s=s+"<label for='equ"+x+"'> "+x+" = "+EQUs[x]+"</label>&nbsp;";
    s=s+"</div>";
  }
}
document.getElementById('EQUs').innerHTML=s;

function renumber() {
  var t=document.getElementById('text2renumber');
  var f=document.getElementById('final');
  var lines=t.value.split('\n');
  var fixed=[];
  var i, j=lines.length-1; // last line is the stop char
  var lineCount=document.getElementById('startLine').value*1;
  var increment=document.getElementById('increment').value*1;
  var labels=[];
  var lc=document.getElementById('labelColor').value;
  var nc=document.getElementById('numColor').value;
  var cc=document.getElementById('comColor').value;
  var sc=document.getElementById('strColor').value;
  var kc=document.getElementById('kwdColor').value;
  for (i=0; i<j; i++) {
    var s=lines[i];
    s=s.replace(/^\d+/,"").trim();
    if(s!="") {
      if(s.search(/^\w+:/)==0) lines[i]=lineCount.toString()+s;
      else if(s.search(/^\*\w+:/)==0) lines[i]=lineCount.toString()+s;
      else if(s.search(/^\w+ EQU /)==0) lines[i]=lineCount.toString()+s;
      else lines[i]=lineCount.toString()+" "+s;
      var ss=lines[i].replace(/^(\d+)([A-Z]\w+):/, "$1<span style=\"color: "+lc+"\">$2</span>:");
      ss=lines[i].replace(/^(\d+)([A-Z]\w+) EQU/, "$1<span style=\"color: "+lc+"\">$2</span> EQU");
      ss=ss.replace(/(\d+)/, "<span style=\"color: "+nc+"\">$1</span>");
      ss=ss.replace(/(;.+)/, "<span style=\"color: "+cc+"\">$1</span>");
      ss=ss.replace(/(0[0-9A-F]+H)/, "<span style=\"color: "+nc+"\">$1</span>");
      ss=ss.replace(/('.+')/, "<span style=\"color: "+sc+"\">$1</span>");
      fixed.push(ss)
      lineCount+=increment;
    }
  }
  t.value=lines.join('\n');
  ss=fixed.join('<br />\n');
  s=t.value;
  console.log("> ",s);
  x=s.matchAll(/\d+(\w+)(:| EQU)/g);
  console.log(x);
  for (match of x) {
    labels.push(match[1]);
    console.log(">",match[1]);
  }
  k=labels.length;
  for (n=0; n<k; n++) {
    var rx=RegExp("("+labels[n]+")(:|<br)","g");
    console.log("rx",rx);
    ss=ss.replace(rx, "<span style='color: "+lc+"'>$1</span>\$2");
  }
  for(i=0; i<opl; i++) {
    s=opcodes[i];
    rx=RegExp("([^\\w>])([A-Z]\\w+)", "g");
    console.log(rx);
    ss=ss.replace(rx, "$1<span style=\"color: "+kc+"\">$2</span>");
  }
  f.innerHTML=ss+"<br /><br /><br />";
}
var target=document.querySelector('#text2renumber');
target.addEventListener('paste', (event) => {
  busy=true;
  console.log("You posted text");
  var paste = (event.clipboardData || window.clipboardData).getData('text').trim()+"\n\n";
  var lns=paste.split("\n");
  lns=lns[0].replace(/^(\d+).+/g,"$1");
  lns=lns*1;
  if(lns>0) startLine.value=lns;
  for (x in EQUs) {
    if(EQUs.hasOwnProperty(x)) {
      rx=RegExp("\\d+"+x+" EQU "+EQUs[x],"g");
      // console.log(rx);
      if(paste.search(rx)>-1) {
        document.getElementById('equ'+x).checked=true;
      } else {
        document.getElementById('equ'+x).checked=false;
      }
    }
  }
  busy=false;
});
document.getElementById('text2renumber').focus();

function cbChanged(x) {
  if(busy==true) return;
  console.log(x, 'cbChanged');
  var cb=document.getElementById(x);
  var n = cb.name;
  var v=cb.value;
  var rp="1"+n+" EQU "+v+"\n";
  if(cb.checked) {
    var ss=document.getElementById('text2renumber').value.replace(v, n);
    var x=ss.search(/\d+(\w+)(:| EQU)/g);
    ss=ss.substr(0, x-1)+"\n"+rp+ss.substr(x+1);
    document.getElementById('text2renumber').value=ss;
  } else {
    var rx=RegExp("\\d+"+n+" EQU "+v+"\n", "g");
    console.log(rx);
    document.getElementById('text2renumber').value=document.getElementById('text2renumber').value.replace(rx, "");
  }
  renumber();
}

const kduino=[
  0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x10, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 
  0x01, 0x00, 0x00, 0xc4, 0x00, 
  0x3f, 0xbf, 0x81, 0xfd, 0xe0, 
  0x7f, 0xff, 0xc3, 0xff, 0xf8, 
  0x7f, 0xff, 0xd3, 0xff, 0xf0, 
  0x30, 0x40, 0x10, 0x00, 0xa0, 
  0x00, 0x00, 0x10, 0x00, 0x00, 
  0x00, 0x00, 0x10, 0x00, 0x00, 
  0x00, 0x00, 0x18, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x3c, 0x00, 0x00, 
  0x00, 0x01, 0xff, 0x80, 0x00, 
  0x00, 0x03, 0xff, 0xc0, 0x00, 
  0x00, 0x0f, 0xff, 0xe0, 0x00, 
  0x00, 0x1f, 0xff, 0xf0, 0x00, 
  0x00, 0x1f, 0xff, 0xf8, 0x00, 
  0x00, 0x3f, 0xff, 0xf8, 0x00, 
  0x00, 0x3f, 0xff, 0xfc, 0x00, 
  0x00, 0x3f, 0xff, 0xfc, 0x00, 
  0x00, 0x7f, 0xff, 0xfc, 0x00, 
  0x00, 0x7f, 0xff, 0xfc, 0x00, 
  0x00, 0x7f, 0xff, 0xfc, 0x00, 
  0x00, 0x7f, 0xff, 0xfc, 0x00, 
  0x00, 0x7f, 0xff, 0xfc, 0x00, 
  0x00, 0x3f, 0xff, 0xfc, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0xc0, 0x00, 0x06, 0x00, 
  0x01, 0x00, 0x00, 0x00, 0x80, 
  0x02, 0x20, 0x00, 0x0c, 0x40, 
  0x04, 0x7e, 0x00, 0xfe, 0x00, 
  0x04, 0x7f, 0xe7, 0xfe, 0x20, 
  0x00, 0xff, 0xef, 0xfe, 0x20, 
  0x00, 0xff, 0xef, 0xfe, 0x20, 
  0x04, 0x7f, 0xe7, 0xfe, 0x20, 
  0x04, 0x73, 0xe7, 0xce, 0x00, 
  0x02, 0x23, 0xc3, 0x84, 0x40, 
  0x01, 0x00, 0x00, 0x00, 0x80, 
  0x00, 0x7f, 0xff, 0xfe, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x3f, 0xff, 0xfc, 0x00, 
  0x00, 0x7f, 0xff, 0xfc, 0x00, 
  0x00, 0x78, 0x00, 0x1c, 0x00, 
  0x00, 0x67, 0xef, 0xe4, 0x00, 
  0x00, 0x47, 0x6e, 0xc0, 0x00, 
  0x00, 0x17, 0x6e, 0xd8, 0x00, 
  0x25, 0x1f, 0xff, 0xf8, 0x20, 
  0x3f, 0x00, 0x00, 0x00, 0xf8, 
  0x7f, 0x57, 0x6e, 0xf5, 0xfc, 
  0x3b, 0x62, 0x64, 0xcc, 0xe0, 
  0x00, 0x7f, 0xff, 0xfc, 0x00, 
  0x00, 0x7f, 0xff, 0xfc, 0x00, 
  0x00, 0x7f, 0xff, 0xfc, 0x00, 
  0x00, 0x0f, 0xff, 0xf0, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00
];

var line=20;
var t=[];
t.push('10 CLS: PRINT "Oh hai!"')
for(i=0; i<328; i++) kduino[i]=~kduino[i];
for(n=0; n<8; n++) {
  for(i=0; i<5; i++) {
    var s="";
    for(bit=7; bit>-1; bit--) {
      var sum = 0;
      for(j=0; j<8; j++) {
        sum+=((kduino[n*40+j*5+i]>>>bit) & 1)<<j;
      }
      if(sum<16) s=s+'0';
      s=s+sum.toString(16).toUpperCase();
    }
    t.push(line.toString()+' GCURSOR ('+(104+i*8).toString()+','+(n*8-7).toString()+')');
    line+=10;
    t.push(line.toString()+' GPRINT "'+s+'"');
    line+=10;
  }
  document.getElementById('text2renumber').value=t.join("\n")
}
</script>
</body>
</html>
