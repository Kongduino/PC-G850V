10 ORG 100H
20 JP MAIN
30RPTCHR EQU 0BFEEH
40GPF EQU 0BFD0H
50AOUT EQU 0BD09H
60PUTSTR EQU 0BFF1H
70WAITK EQU 0BFCDH
80LDPSTR EQU 0BD00H
90REGOUT EQU 0BD03H

100MAIN: CALL CLS
110 LD HL,DPSET
120 CALL STRLN
130 LD DE,0
140 CALL PUTSTR
150 CALL GTVRAM ; get copy of vram
160 LD A,12
170 LD (POSY),A
180 LD A,133
190 LD (POSX),A
200 CALL PSET
210 LD A,120
220 LD (POSX),A
230 LD A,22
240 LD (POSY),A
250 CALL PSET
260 CALL DSPLAY ; copy to screen
270 CALL WAIT

280 LD HL,DHLINE
290 CALL STRLN
300 LD DE,0
310 CALL PUTSTR
320 CALL GTVRAM
330 LD A,32
340 LD (POSY),A
350MAIN00: LD A,10
360 LD (POSX),A
370 LD A,133
380 LD (ENDX),A
390 CALL HLINE ; 10,[32-42] to 133,[32-42]
400 LD A,(POSY)
410 INC A
420 INC A ; +2 increment
430 LD (POSY),A
440 CP 42
450 JP NZ,MAIN00
460 CALL DSPLAY
470 CALL WAIT

480 LD HL,DVLINE
490 CALL STRLN
500 LD DE,0
510 CALL PUTSTR
520 CALL GTVRAM
530 LD A,80
540 LD (POSX),A
550 LD A,28
560 LD (ENDY),A
570MAIN02: LD A,10
580 LD (POSY),A
590 CALL VLINE ; [80-90],10 to [80-90],28
600 LD A,(POSX)
610 INC A
620 INC A ; +2 increment
630 LD (POSX),A
640 CP 90
650 JP NZ,MAIN02
660 CALL DSPLAY
670 CALL WAIT

680 CALL CLS
690 CALL CLVRAM ; clear screen and vram
700 LD HL,RNDPNT
710 CALL STRLN
720 LD DE,0
730 CALL PUTSTR
740 CALL GTVRAM
750 LD B,8 ; 8 TIMES
760FILL01: PUSH BC
770 LD B,0 ; 256 TIMES = 2,048 points
780FILL00: PUSH BC
790 CALL PRNG ; pseudo-random number
800 LD D,143
810 CALL DVDX ; A = A modulo 143
820 LD (POSX),A
830 CALL PRNG
840 LD D,45
850 CALL DVDX ; A = A modulo 45
860 LD (POSY),A
870 CALL PSET
880 POP BC
890 DJNZ FILL00
900 POP BC
910 DJNZ FILL01

940 LD A,48
950 LD (POSY),A
960MAIN01: LD A,100
970 LD (POSX),A
980 LD A,144
990 LD (ENDX),A
1000 CALL HLINE ; 100,[48-60] to 144,[48-60]
1010 LD A,(POSY)
1020 INC A
1030 INC A ; +2 increment
1040 LD (POSY),A
1050 CP 60
1060 JP NZ,MAIN01
920 CALL DSPLAY ; copy to screen
930 CALL WAIT

940 LD B,16
950 LD A,50H
960 OUT (40H),A
970 CALL VBWEHT
980 CALL VBWEHT
990 CALL VBWEHT
1000 CALL VBWEHT ; 1 SEC
1010 CALL VBWEHT
1020 CALL VBWEHT
1030 CALL VBWEHT
1040 CALL VBWEHT ; 1 SEC

1830 LD A,40H
1840 OUT(40H),A
1850 CALL CLS
1860 LD HL,BYEBYE
1870 CALL STRLN
1880 LD DE,0
1890 CALL PUTSTR
1900 RET

1950WAIT: CALL WAITK
1960 OR A
1970 JP Z,WAIT
1980 RET

2000CLS: LD B,144
2010 LD DE,0000H
2020CLS0: LD A,32
2030 CALL RPTCHR
2040 RET
2050CLLN: LD B,24
2060 LD E,0
2070 JP CLS0

2100CLVRAM: LD HL,VRAM0
2110 AND A
2120 LD B,144
2130CVRAM0: LD (HL),A
2140 INC HL ; clear the first 144 bytes
2150 DJNZ CVRAM0
2160 LD DE,VRAM1
2170 LD BC,144
2180 LD HL,VRAM0
2190 LDIR ; copy that to the next 144 bytes
2200 LD BC,288
2210 LD HL,VRAM0
2220 LDIR ; use the top 288 bytes
2230 LD BC,288
2240 LD HL,VRAM0
2250 LDIR ; to clear the rest
2260 LD BC,288
2270 LD HL,VRAM0
2280 LDIR ; EXTRA 2 LINES FOR SCROLL
2290 RET ; Hat Tip @hwreverse

2300VRAM0: DS 144
2310VRAM1: DS 144
2320VRAM2: DS 144
2330VRAM3: DS 144
2340VRAM4: DS 144
2350VRAM5: DS 144
2360VRAM6: DS 144
2370VRAM7: DS 144

2380GTVRAM: LD HL,VRAM0
2390 LD DE,0000H
2400 LD B,144
2410 CALL LDPSTR ; get 144 chars from Y=0, X=0
2420 LD HL,VRAM1
2430 LD DE,0100H
2440 LD B,144
2450 CALL LDPSTR
2460 LD HL,VRAM2
2470 LD DE,0200H
2480 LD B,144
2490 CALL LDPSTR
2500 LD HL,VRAM3
2510 LD DE,0300H
2520 LD B,144
2530 CALL LDPSTR
2540 LD HL,VRAM4
2550 LD DE,0400H
2560 LD B,144
2570 CALL LDPSTR
2580 LD HL,VRAM5
2590 LD DE,0500H
2600 LD B,144
2610 CALL LDPSTR ; get 144 chars from Y=5, X=0
2620 LD HL,VRAM6
2630 LD DE,0600H
2640 LD B,144
2650 CALL LDPSTR
2660 LD HL,VRAM7
2670 LD DE,0700H
2680 LD B,144
2690 CALL LDPSTR ; EXTRA 2 LINES FOR SCROLL
2700 RET

2710DSPLAY: LD HL,VRAM0
2720 LD DE,0000H
2730 LD B,144
2740 CALL GPF ; display 144 8-bit columns from Y=0, X=0
2750 LD HL,VRAM1
2760 LD DE,0100H
2770 LD B,144
2780 CALL GPF
2790 LD HL,VRAM2
2800 LD DE,0200H
2810 LD B,144
2820 CALL GPF
2830 LD HL,VRAM3
2840 LD DE,0300H
2850 LD B,144
2860 CALL GPF
2870 LD HL,VRAM4
2880 LD DE,0400H
2890 LD B,144
2900 CALL GPF
2910 LD HL,VRAM5
2920 LD DE,0500H
2930 LD B,144
2940 CALL GPF ; display 144 8-bit columns from Y=5, X=0
2950 LD HL,VRAM6
2960 LD DE,0600H
2970 LD B,144
2980 CALL GPF
2990 LD HL,VRAM7
3000 LD DE,0700H
3010 LD B,144
3020 CALL GPF ; EXTRA 2 LINES FOR SCROLL
3030 RET

3500BYTE: PUSH AF
3510 AND 0F0H
3520 RRCA
3530 RRCA
3540 RRCA
3550 RRCA
3560 CALL NIBBLE
3570 INC HL
3580 POP AF
3590 AND 15
3600 CALL NIBBLE
3610 INC HL
3620 RET
3630NIBBLE: SUB 10
3640 JP M,ZERO9
3650 ADD A,7
3660ZERO9: ADD A,58
3670 LD (HL),A
3680 RET

4000CALCXY: LD HL,VRAM0
4010 LD A,(POSY)
4020 SRL A
4030 SRL A
4040 SRL A ; Y / 8
4050 OR A ; cp 0
4060 JP Z,CALC00 ; already where we want to be
4070 LD B,A
4080 LD DE,144 ; add a line's worth
4090CALC01: ADD HL,DE
4100 DJNZ CALC01 ; loop
4110CALC00: ; HL = beginning of line Y
4120 LD A,(POSX) ; x
4130 LD C,A
4140 LD B,0
4150 ADD HL,BC ; HL = exactly at pos x,y
4160 LD A,(POSY) ; y
4170 CALL DVD8 ; A = bit offset
4180 LD (REMNY),A
4190 OR A ; cp 0
4200 JP NZ,CALC02 ; if A = 0, set to 1
4210 LD A,1
4220 JP CALC03
4230CALC02: LD B,A ; else shift '1' left B times
4240 LD A,1
4250CALC04: SLA A; A << 1
4260 DJNZ CALC04
4270CALC03: LD B,A ; bit offset in B
4280 LD A,(HL) ; 8 bits in A
4290 RET ; Now do what you want with A (current bit pattern) and B (bit offset)

4380PSET: CALL CALCXY
4390 OR B ; set to black
4400 LD (HL),A
4440 RET

4450PUNSET: CALL CALCXY
4460 XOR B ; set to white
4470 LD (HL),A
4510 RET

4520PGET: CALL CALCXY
4530 AND B ; is it black?
4540 RET

4550HLINE: CALL CALCXY ; don't call PSET (and CALCXY) repeatedly
4560HLINE0: OR B ; DIY. set to black
4570 LD (HL),A
4580 LD A,(ENDX)
4590 LD D,A
4600 LD A,(POSX)
4610 INC A
4620 LD (POSX),A
4630 CP D ; are we done?
4640 RET Z ; yes, bail.
4650 INC HL ; no, increment HL
4660 LD A,(HL)
4670 JP HLINE0 ; and loop
4680 RET

4690VLINE: CALL CALCXY ; harder to optimize like HLINE
4700VLINE0: OR B ; DIY. set to black
4710 LD (HL),A
4720 LD A,(ENDY)
4730 LD D,A
4740 LD A,(POSY)
4750 INC A
4760 LD (POSY),A
4770 CP D
4780 RET Z
4790 LD A,B
4800 CP 128 ; Last bit in the column?
4810 JP NZ,VLINE1
4820 LD DE,144
4830 ADD HL,DE
4840 LD B,1
4845 LD A,(HL)
4850 JP VLINE0
4860VLINE1: SLA B
4865 LD A,(HL)
4870 JP VLINE0


4880POSX: DB 0
4890POSY: DB 0
4900ENDX: DB 0
4910ENDY: DB 0
4920REMNX: DB 0
4930CHARX: DB 0
4940REMNY: DB 0
4950CHARY: DB 0
4960BUFFER: DB 0,0,0,0,0,0
4970TMP: DB 0

4980HX2DEC: PUSH HL
4990 LD B,'0'
5000 LD (HL),B
5010HDEC00: LD (TMP),A
5020 CP 100
5030 JP M,HDEC01
5040 INC (HL)
5050 SUB 100
5060 JP HDEC00
5070HDEC01: INC HL
5080 LD B,'0'
5090 LD (HL),B
5100 LD A,(TMP)
5110HDEC02: LD (TMP),A
5120 CP 10
5130 JP M,HDEC03
5140 INC (HL)
5150 SUB 10
5160 JP HDEC02
5170HDEC03: INC HL
5180 LD A,(TMP)
5190 ADD A,48
5200 LD (HL),A
5210 POP HL ; remove heading 0s
5220 LD A,(HL)
5230 CP '0'
5240 JP NZ,HDEC05
5250 LD A,' '
5260 LD (HL),A
5270HDEC04: INC HL
5280 LD A,(HL)
5290 CP '0'
5300 JP NZ,HDEC05
5310 LD A,' '
5320 LD (HL),A
5330HDEC05: RET

6000 ; A <-- INPUT
6010 ; A --> REMAINDER. B --> QUOTIENT
6020DVD6: LD B,0
6030DVD6A: CP 6
6040 RET M
6050 SUB 6
6060 INC B
6070 JP DVD6A

6080DVD8: LD B,0
6090DVD8A: CP 8
6100 RET M
6110 SUB 8
6120 INC B
6130 JP DVD8A

6140DVDX: LD B,0
6150DVDXA: CP D
6160 RET M
6170 SUB D
6180 INC B
6190 JP DVDXA

6200STRLN: LD B,0
6210 PUSH HL ;preserve HL
6220STRLN0: LD A,(HL)
6230 OR A
6240 JP Z,STRLN1
6250 INC HL
6260 INC B
6270 JP STRLN0
6280STRLN1: POP HL ;restore HL
6290 RET

6300DPSET:  DB 'PSET         ',0
6310DHLINE: DB 'HLINE        ',0
6320DVLINE: DB 'VLINE        ',0
6340RNDPNT: DB 'Random points',0
6350BYEBYE: DB 'Goodbye!',0

7000 ; change Seed value for LCM PRNG
7010PRNG: PUSH DE ;  Code by @hwreverse
7020 PUSH HL
7030 LD DE,(RVAL16)
7040 LD H,E
7050 LD L,1
7060 ADD HL,DE
7070 ADD HL,DE
7080 ADD HL,DE
7090 ADD HL,DE
7100 ADD HL,DE
7110 LD A,H
7120 LD (RVAL16),HL
7130 POP HL
7140 POP DE
7150 LD A,(RVAL88) ; 0-255
7170 RET ; will use modulo to restrict range

7200RVAL16: DB 30H
7210RVAL88: DB 81H
7300DX: DB 0
7310DY: DB 0
7320MYD: DB 0

7500VBWEHT: LD B,250
7510BWEHT: PUSH BC
7520 CALL WEHT ; ~1 millisec
7530 POP BC
7540 DJNZ BWEHT
7550 RET

7560WEHT: LD B,241
7570WEHT0: NOP
7580 NOP
7590 NOP
7600 NOP
7610 NOP
7620 DJNZ WEHT0
7630 RET

