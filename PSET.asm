10 ORG 100H
20 JP MAIN
30RPTCHR EQU 0BFEEH
40GPF EQU 0BFD0H
50AOUT EQU 0BD09H
60PUTSTR EQU 0BFF1H
70WAITK EQU 0BFCDH
80LDPSTR EQU 0BD00H


100MAIN: CALL CLS
110 LD A,133 ; x = 133
120 CALL DVD6 ; 22 / remain 1
130 LD (REMNX),A
140 LD A,B
150 LD (CHARX),A
160 LD A,12 ; y = 12
170 CALL DVD8 ; 1 / remain 4
180 LD (REMNY),A
190 LD A,B
200 LD (CHARY),A
210 LD D,A
220 LD A,(CHARX)
230 LD E,A
240 PUSH DE ; POSY/POSX
250 LD HL, BUFFER
260 LD B,6
270 CALL LDPSTR ; read 6 bytes
280 LD HL,BUFFER
290 LD A,(HL) ; first column
300 OR 81H ; top/bottom pixels black
310 LD (HL),A
320 LD A,(REMNX)
330 CP 0
340 JP Z, MAIN00
350 ; ADD A TO HL: offset
360 ADD A, L ; A = A+L
370 LD L, A ; L = A+L
380 ADC A, H ; A = A+L+H+CARRY
390 SUB L ; A = H+CARRY
400 LD H, A ; H = H+CARRY
410MAIN00: LD A,(REMNY) ; bit offset
420 LD B,A
430 LD A,(HL)
440 OR B ; black
450 LD (HL),A
460 LD HL,BUFF5 ; last column
470 LD A,(HL)
480 OR 81H ; top/bottom pixels black
490 LD (HL),A
500 LD HL,BUFFER
510 POP DE
520 LD B,6
530 CALL GPF ; draw
540 LD A,133
550 CALL DVD6
560 PUSH AF
570 LD A,B
580 LD HL,RSLT0
590 CALL BYTE
600 POP AF
610 LD HL,RSLT1
620 CALL BYTE
630 LD HL,RSLT
640 LD DE,0000H
650 CALL STRLN
660 CALL PUTSTR
670 LD A,12
680 CALL DVD8
690 PUSH AF
700 LD A,B
710 LD HL,RSLT0
720 CALL BYTE
730 POP AF
740 LD HL,RSLT1
750 CALL BYTE
760 LD HL,RSLT
770 LD DE,0100H
780 CALL STRLN
790 CALL PUTSTR

1100WAIT: CALL WAITK
1110 CP 0
1120 JP Z,WAIT
1130 RET

2000CLS: LD B, 144
2010 LD DE, 0
2020CLS0: LD A, 32
2030 CALL RPTCHR
2040 RET
2050CLLN: LD B,24
2060 LD E,0
2070 JP CLS0

3000BYTE: PUSH AF
3620 AND 0F0H
3630 RRCA
3640 RRCA
3650 RRCA
3660 RRCA
3670 CALL NIBBLE
3680 INC HL
3690 POP AF
3700 AND 15
3710 CALL NIBBLE
3720 INC HL
3730 RET
3740NIBBLE: SUB 10
3750 JP M,ZERO9
3760 ADD A,7
3770ZERO9: ADD A,58
3780 LD (HL),A
3790 RET

5000DVD6: LD B,0
5010DVD6A: CP 6
5020 RET M
5030 SUB 6
5035 INC B
5040 JP DVD6A

5100DVD8: LD B,0
5010DVD8A: CP 8
5020 RET M
5030 SUB 8
5035 INC B
5040 JP DVD8A


5270STRLN: LD B,0
5280 PUSH HL ;preserve HL
5290STRLN0: LD A,(HL)
5300 CP 0
5310 JP Z,STRLN1
5320 INC HL
5330 INC B
5340 JP STRLN0
5350STRLN1: POP HL ;restore HL
5360 RET


6000RSLT: DB 'Q: 0x'
6010RSLT0: DB 0, 0, ', R: 0x'
6020RSLT1: DB 0, 0, 0
6030REMNX: DB 0
6040CHARX: DB 0
6050REMNY: DB 0
6060CHARY: DB 0

6200BUFFER: DB 0,0,0,0,0
6210BUFF5: DB 0

