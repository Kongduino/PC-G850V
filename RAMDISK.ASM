10 ORG 100H
20 JP MAIN
30PUTSTR EQU 0BFF1H
40INKEY EQU 0BE53H
50PUTCHR EQU 0BE62H
60WAITK EQU 0BFCDH
70RPTCHR EQU 0BFEEH
80GPF EQU 0BFD0H
90LDPSTR EQU 0BD00H

100PSN: DB 0
110ADDR: DW 0
120RAMBUF: DEFS 128
130TEMP: DW 0

140SRMON0: DB 'RAMON  '
150SRMON1: DB 0,0,0,0,' ADDR '
160SADDR0: DB 0,0,0,0,0
170SRMOF0: DB 'RAMOFF '
180SRMOF1: DB 0,0,0,0,' PSN  '
190SPSN0: DB 0,0,0,0,0
200SRMBF0: DB 'RAMBUF '
210STEMP0: DB 0,0,0,0,' TEMP '
220STEMP1: DB 0,0,0,0,0
230B2R00: DB 'BANK2R '
240B2R01: DB 0,0,0,0,' R2BANK '
250R2B00: DB 0,0,0,0,0
260DONE: DB '- THE END -',0

270MAIN: CALL CLS
280 LD HL,SRMON1
290 LD DE,RAMON
300 LD A,D
310 CALL BYTE
320 LD A,E
330 CALL BYTE
340 LD HL,SADDR0
350 LD DE,ADDR
360 LD A,D
370 CALL BYTE
380 LD A,E
390 CALL BYTE
400 LD HL,SRMON0
410 LD DE,0000H
420 CALL STRLN
430 CALL PUTSTR

440 LD HL,SRMOF1
450 LD DE,RAMOFF
460 LD A,D
470 CALL BYTE
480 LD A,E
490 CALL BYTE
500 LD HL,SPSN0
510 LD DE,PSN
520 LD A,D
530 CALL BYTE
540 LD A,E
550 CALL BYTE
560 LD HL,SRMOF0
570 LD DE,0100H
580 CALL STRLN
590 CALL PUTSTR

600 LD HL,STEMP0
610 LD DE,RAMBUF
620 LD A,D
630 CALL BYTE
640 LD A,E
650 CALL BYTE
660 LD HL,STEMP1
670 LD DE,TEMP
680 LD A,D
690 CALL BYTE
700 LD A,E
710 CALL BYTE
720 LD HL,SRMBF0
730 LD DE,0200H
740 CALL STRLN
750 CALL PUTSTR
760 LD HL,DONE
770 LD DE,0400H
780 CALL STRLN
790 CALL PUTSTR

800 LD HL,B2R01
810 LD DE,BANK2R
820 LD A,D
830 CALL BYTE
840 LD A,E
850 CALL BYTE
860 LD HL,R2B00
870 LD DE,R2BANK
880 LD A,D
890 CALL BYTE
900 LD A,E
910 CALL BYTE
920 LD HL,B2R00
930 LD DE,0300H
940 CALL STRLN
950 CALL PUTSTR
960 LD HL,DONE
970 LD DE,0400H
980 CALL STRLN
990 CALL PUTSTR

1000 CALL WAITK
1010 RET


5000CLS: LD B,144
5010 LD DE,0
5020CLS0: LD A,32
5030 CALL RPTCHR
5040 RET
5050CLLN: LD B,24
5060 LD E,0
5070 JP CLS0

5080BYTE: PUSH AF
5090 AND 0F0H
5100 RRCA
5110 RRCA
5120 RRCA
5130 RRCA
5140 CALL NIBBLE
5150 INC HL
5160 POP AF
5170 AND 15
5180 CALL NIBBLE
5190 INC HL
5200 RET
5210NIBBLE: SUB 10
5220 JP M,ZERO9
5230 ADD A,7
5240ZERO9: ADD A,58
5250 LD (HL),A
5260 RET

5270STRLN: LD B,0
5280 PUSH HL ;preserve HL
5290STRLN0: LD A,(HL)
5300 CP 0
5310 JP Z,STRLN1
5320 INC HL
5330 INC B
5340 JP STRLN0
5350STRLN1: POP HL ;restore HL
5360 RET

5370PUTBNR: CALL STRLN
5380 LD A,24
5390 SUB B
5400 RRCA
5410 LD E,A
5420 CALL PUTSTR
5430 RET

5440MX2KEY: LD B,0
5450 LD C,A ;A IS KEY INDEX
5460 LD HL,MATRIX
5470 ADD HL,BC
5480 LD A,(HL)
5490 RET

5500HEX2N: LD A,(HL)
5510 CALL HEX1
5520 ADD A,A
5530 ADD A,A
5540 ADD A,A
5550 ADD A,A
5560 LD B,A
5570 INC HL
5580 LD A,(HL)
5590 CALL HEX1
5600 OR B
5610 RET

5620HEX1: SUB '0'
5630 CP 10
5640 RET C
5650 SUB 7 ;'A'-'0'-10
5660 RET

5670MATRIX: DB 0,0FFH
5680 DB 'QWERTYUASDFGHJKZXCVBNM,'
5690 DB 0FFH,0FFH,0FFH,0FFH,9,32,10,11,14,15 ;LEFT RIGHT UP DOWN
5700 DB 0FFH,'0.=+',13,'L;',0FFH,'123-'
5710 DB 0FFH,'IO',0FFH,'456*',0FFH,'P',8,0FFH,'789/)'
5720 DB 0FFH,0FFH,0FFH,0FFH,'(',0FFH,0FFH,0FFH,0FFH,0FFH,0FFH,0FFH,0FFH
5730 DB 0,12,0FFH

5740RAMON: DI
5750 IN A,(17H)
5760 LD (V19A),A
5770 LD A,0
5780 OUT (17H),A ;disable periph. interrupts
5790 IN A, (19H)
5800 LD (V19B),A
5810 LD B, 50H ;/CEROM2=L,  BANK1=0, BANK0=1
5820 OR B
5830 OUT (19H),A ;enable ext. ram to 0x8000-0xC0000
5840 RET

5850RAMOFF: LD A,(V19B)
5860 OUT (19H),A
5870 LD A,(V19A)
5880 OUT (17H),A ;re-enable ROM
5890 EI
5900 RET
5910V19A: DB 0
5920V19B: DB 0

5930BANK2R: LD HL,(ADDR)
5940 LD DE,RAMBUF
5950 LD B,24
5960 CALL RAMON
5970LOOP00: LD A,(HL)
5980 LD (DE),A
5990 INC HL
6000 INC DE
6010 DJNZ LOOP00
6020 CALL RAMOFF
6030 RET

6040R2BANK: LD HL,RAMBUF
6050 LD DE,(ADDR)
6060 LD B,24
6070 CALL RAMON
6080LOOP01: LD A,(HL)
6090 LD (DE),A
6100 INC HL
6110 INC DE
6120 DJNZ LOOP01
6130 CALL RAMOFF
6140 RET

