10 ORG 100H
20PUTSTR EQU 0BFF1H
30WAITK EQU 0BFCDH
40RPTCHR EQU 0BFEEH
50 CALL CLS
60 LD HL,GREET
70 CALL STRLN
80 LD DE,0000H
90 CALL PUTSTR
100 LD A,1
110 OUT (60H),A ; 8-BIT PIO
120 LD A,0
130 OUT (61H),A ; ALL OUTPUT
140 CALL WAIT
150ENCORE: LD HL,START
160 CALL STRLN
170 LD DE,0100H
180 CALL PUTSTR
190 CALL MYLOOP
200 LD HL,STOP
210 CALL STRLN
220 LD DE,0200H
230 CALL PUTSTR
240 LD HL,CNTN
250 CALL STRLN
260 LD DE,0300H
270 CALL PUTSTR
280 CALL WAIT
290 CALL MX2KEY
300 CP 'Q'
310 JP Z,THEEND
320 CP '8'
330 JP Z,EIGHT
340 CP '4'
350 JP Z,FOUR
360 CALL CLS
370 JP ENCORE
380EIGHT: LD A,0
390 OUT (67H),A
400 CALL CLS
410 LD HL,EIGHT8
420 CALL STRLN
430 LD DE,0000H
440 CALL PUTSTR
450 JP ENCORE
460FOUR: LD A,1
470 OUT (67H),A
480 CALL CLS
490 LD HL,FOUR4
500 CALL STRLN
510 LD DE,0000H
520 CALL PUTSTR
530 JP ENCORE

1100WAIT: CALL WAITK
1110 CP 0
1120 JP Z,WAIT
1130 RET

1140THEEND: LD A,0
1150 OUT (67H),A
1160 LD HL,BYE
1170 CALL STRLN
1180 LD DE,0500H
1190 CALL PUTSTR
1200 RET

2000CLS: LD A,144
2010 LD (CLSN),A
2020 LD DE,0
2030 LD (CLSX),DE
2040 LD A,32
2050 LD (CHAR),A
2060CLS0: LD A,(CLSN)
2070 LD B,A
2080 LD A,(CHAR)
2090 LD DE,(CLSY)
2100 CALL RPTCHR
2110 RET
2120CLSN: DB 144
2130CLSY: DB 0
2140CLSX: DB 0
2150CHAR: DB 32

3450STRLN: LD B,0
3460 PUSH HL
3470STRLN0: LD A,(HL)
3480 CP 0
3490 JP Z,STRLN1
3500 INC HL
3510 INC B
3520 JP STRLN0
3530STRLN1: POP HL
3540 RET

3540MX2KEY: LD B,0
3550 LD C,A ; A IS KEY INDEX
3560 LD HL,MATRIX
3570 ADD HL,BC
3580 LD A,(HL)
3590 RET

4000MYLOOP: LD A,128 ; Bit 7: last pin (after VSS & GND) is HIGH. 2 cycles
4010 ; change A's value to match the pin(s) you want to flip
4020 OUT (62H),A ; HIGH ; 3 cycles
4030 LD A,0 ; (256 times) 2 cycles
4040MLP01: PUSH AF ; 3 cycles
4050 LD A,0 ; (256 times) 2 cycles
4060MLP00: PUSH AF ; 3 cycles
4070 LD HL,LOOP0 ; 2 cycles
4080 LD DE,LOOP1 ; 2 cycles
4090 LD BC,32 ; 2 cycles
4100 LDIR ; 4/5 cycles
4110 POP AF ; 3 cycles
4120 DEC A ; 1 cycle
4130 JP NZ,MLP00 ; 3 cycles
4140 POP AF ; 3 cycles
4150 DEC A ; 1 cycle
4160 JP NZ,MLP01 ; 3 cycles
4170 LD A,0 ; 2 cycles
4180 OUT (62H),A ; all pins are LOW ; 3 cycles
4190 RET ; 3 cycles

4200LOOP0: DB 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16
4210 DB 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16
4220LOOP1: DB 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
4230 DB 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0

5000GREET: DB 'Hit key to start',0
5010START: DB 'Start...',0
5020STOP: DB 'Stop...',0
5030BYE: DB 'Good Bye...',0
5040CNTN: DB 'Q / 4 / 8 / other',0
5050MATRIX: DB 0,0FFH
5060 DB 'QWERTYUASDFGHJKZXCVBNM,'
5070 DB 0FFH,0FFH,0FFH,0FFH,9,32,10,11,14,15 ; LEFT RIGHT UP DOWN
5080 DB 0FFH,'0.=+',13,'L;',0FFH,'123-'
5090 DB 0FFH,'IO',0FFH,'456*',0FFH,'P',8,0FFH,'789/)'
5100 DB 0FFH,0FFH,0FFH,0FFH,'(',0FFH,0FFH,0FFH,0FFH,0FFH,0FFH,0FFH,0FFH
5110 DB 0,12,0FFH
5120EIGHT8: DB 'Switching to 8 MHz',0
5130FOUR4: DB 'Switching to 4 MHz',0


