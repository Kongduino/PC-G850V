10 ORG 100H
20 JP MAIN
30WRASR EQU 0BFAFH
40PUTSTR EQU 0BFF1H
50INKEY EQU 089BEH
60PUTCHR EQU 08440H
70INITSR EQU 0871AH
80AOUT EQU 0BD09H
90OPENSR EQU 0BCE8H
100CLOSSR EQU 0BCEBH
110LRDSR EQU 0BD15H
120WAITK EQU 0BFCDH
130WCHRSR EQU 0BFAFH
140WSTSR EQU 0BFB2H
150A2HEX EQU 0F9BDH
160RPTCHR EQU 0BFEEH
170MAIN: CALL INITSR
180 CALL OPENSR
190 CALL CLS
200 LD HL, GREET
210 CALL STRLN
220 LD A, B
230 LD HL, GREET
240 LD DE, 00004H
250 CALL PUTSTR
260 LD A, B
270 LD HL, GREET
280 CALL WSTSR
290 LD HL, MENUM0
300 CALL STRLN
310 LD HL, MENUM0
320 LD DE, 00100H
330 CALL PUTSTR
340 LD HL, MENUM1
350 CALL STRLN
360 LD HL, MENUM1
370 LD DE, 00200H
380 CALL 0BFF1H
390 LD HL, MENUM2
400 CALL STRLN
410 LD A, 24
420 DEC B
430 LD E, A
440 LD HL, MENUM2
450 LD DE, 00300H
460 CALL 0BFF1H
470MAIN0: CALL WAITK
515 CALL MX2KEY
480 CP 'Q'
490 JP Z, THEEND
500 CP 'R'
510 JP Z, RECV

970 JP MAIN0
980THEEND: CALL CLOSSR
990 CALL CLS
1000 LD HL, ZOIGIN
1010 CALL STRLN
1020 LD HL, ZOIGIN
1030 LD DE, 0
1040 CALL 0BFF1H
1050 RET

1000RECV: LD HL, RECVMS
1010 CALL STRLN
1020 LD HL, RECVMS
1030 LD DE, 00300H
1040 CALL PUTSTR
1050 LD HL, BUFFER
1060 CALL LRDSR
1070 LD HL, BUFFER
1080 CALL STRLN
1090 LD HL, BUFFER
1100 LD DE, 00400H
1110 CALL PUTSTR
1120 LD DE, 00300H
1130 CALL CLLN
1140 JP MAIN0
1150NM2DEC: LD BC,-10000
1160 CALL NMDC1
1170 LD BC,-1000
1180 CALL NMDC1
1190 LD BC,-100
1200 CALL NMDC1
1210 LD C,-10
1220 CALL NMDC1
1230 LD C,B
1240NMDC1: LD A,-1
1250NMDC2: INC A
1260 ADD HL,BC
1270 JR C, NMDC2
1280 SBC HL,BC
1290 ADD A,48
1300 LD (DE),A
1310 INC DE
1320 RET

1330CLS: LD B, 144
1340 LD DE, 0
1350CLS0: LD A, 32
1360 CALL RPTCHR
1370 RET
1380CLLN: LD B,24
1390 LD E,0
1400 JP CLS0

1700BYTE: PUSH AF
1710 AND 0F0H
1720 RRCA
1730 RRCA
1740 RRCA
1750 RRCA
1760 CALL NIBBLE
1770 INC HL
1780 POP AF
1790 AND 15
1800 CALL NIBBLE
1810 INC HL
1820 RET
1830NIBBLE: SUB 10
1840 JP M, ZERO9
1850 ADD A, 7
1860ZERO9: ADD A, 58
1870 LD (HL), A
1880 RET
1890STRLN: LD B, 0
1900STRLN0: LD A, (HL)
1910 CP 0
1920 JP Z, STRLN1
1930 INC HL
1940 INC B
1950 JP STRLN0
1960STRLN1: RET

2000MX2KEY: LD B,0
2010 LD C,A ; A IS KEY INDEX
2020 LD HL, MATRIX
2030 ADD HL, BC
2040 LD A,(HL)
2050 RET

3000GREET: DB '- LoRa Messenger -',13,10,0
3010MENUM0: DB '[s]end    se[t]tings',13,10,0
3020MENUM1: DB '[r]eceive [q]uit',13,10,0
3030MENUM2: DB 'SELECT MENU',13,10,0
3030RECVMS: DB 'receiving...',0
3040BUFFER: DEFS 64
3050 DB 0,0,0,0
3060ZOIGIN: DB 'Bye...',13,10,0

4900MATRIX: DB 0,0FFH
4910 DB 'QWERTYUASDFGHJKZXCVBNM,'
4920 DB 0FFH,0FFH,0FFH,0FFH,9,32,10,11,14,15 ; LEFT RIGHT UP DOWN
4930 DB 0FFH, '0.=+',13,'L;',0FFH,'123-'
4940 DB 0FFH,'IO',0FFH,'456*',0FFH,'P',8,0FFH,'789/)'
4950 DB 0FFH,0FFH,0FFH,0FFH,'(',0FFH,0FFH,0FFH,0FFH,0FFH,0FFH,0FFH,0FFH
4960 DB 0,12,0FFH

