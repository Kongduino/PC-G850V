10 ORG 100H
20 JP MAIN
30REGOUT EQU 0BD03H
40PUTSTR EQU 0BFF1H
50INKEY EQU 0BE53H
60PUTCHR EQU 0BE62H
70WAITK EQU 0BFCDH
80RPTCHR EQU 0BFEEH
90GPF EQU 0BFD0H
100LDPSTR EQU 0BD00H

110MAIN: CALL PREPSR
120 LD HL,GREET0
130 CALL PUTSR1
140 XOR A
150 LD (MSGIDX),A
160 LD (STATUS),A
170 DEC A ; 0FFH -1
180 LD (NUMMSG),A
190 LD DE,STOCK
200 LD (MSGBUF),DE

210MNCLS: CALL CLS
220 LD HL,GREET
230 CALL PUTBNR
240 LD HL,MENUM0
250 CALL STRLN
260 LD DE,0200H
270 CALL PUTSTR
280 LD HL,MENUM2
290 CALL STRLN
300 LD DE,0500H
310 CALL PUTSTR
320 LD A,(NUMMSG)
330 CP 0FFH
340 JP Z,MAIN0
350 CALL DRAWMB
360 LD A,(NUMMSG)
370 ADD A,31H ; +1 (FF --> 0) +48 (ASCII)
380 LD (MENUMB),A
390 LD HL,MENUM1
400 CALL STRLN
410 LD DE,0300H
420 CALL PUTSTR

430MAIN0: IN A,(71H)
440 AND 2
450 JP NZ,RECV
460 CALL INKEY
470 CP 0
480 JP Z,MAIN0
490 CALL MX2KEY
500 CP 'Q' ; quit
510 JP Z,THEEND
520 CP 'P'
530 JP Z,PING
540 CP '/'
550 JP Z,PREFS
560 CP 'M'
570 JP Z,SHMBOX
580 JP MAIN0

590THEEND: CALL CLS
600 CALL WAITK
610 LD HL,ZOIGIN
620 CALL STRLN
630 LD HL,ZOIGIN
640 LD DE,0
650 CALL PUTSTR
660 RET

670RECV: LD DE,0400H
680 LD HL,RCVSTR
690 CALL STRLN
700 CALL PUTSTR
710 LD HL,MSGBUF
720 LD A,(NUMMSG)
730 INC A
740 LD (NUMMSG),A
750 CP 4
760 JP M,RECV0
770 DEC A
780 LD (NUMMSG),A
790 LD BC,128
800 LD HL,STOCK
810 ADD HL,BC
820 LD DE,STOCK
830 LD BC,384
840 LDIR ; COPY 1~3 TO 0~2
850RECV0: LD B,128
860 LD HL,(MSGBUF)
870 XOR A
880RECV1: LD (HL),A
890 DJNZ RECV1 ; ZERO BUFFER
900 LD B,128
910RECV4: IN A,(72H)
920 CP 1AH
930 JP Z,RECV3
940 LD (HL),A
950 INC HL
960RECV2: IN A,(71H)
970 AND 2
980 JP Z,RECV2
990 DJNZ RECV4
1000RECV3: LD A,(NUMMSG)
1010 CP 3
1020 JP Z,RECV5
1030 LD HL,(MSGBUF)
1040 LD BC,128
1050 ADD HL,BC
1060 LD (MSGBUF),HL
1070RECV5: LD HL,STOCK
1080 LD DE,MSGBUF
1090 LD A,(NUMMSG)
1100 ; CALL REGOUT
1110 JP MNCLS

1120PING: LD HL,BFPING
1130 CALL PUTSR1
1140 LD DE,0400H
1150 LD HL,SPING
1160 CALL STRLN
1170 LD DE,0400H
1180 CALL PUTSTR
1190 LD B,250
1200 CALL BWEHT
1210 LD B,250
1220 CALL BWEHT
1230 LD B,250
1240 CALL BWEHT
1250 LD B,250
1260 CALL BWEHT
1270 LD B,250
1280 CALL BWEHT
1290 LD B,250
1300 CALL BWEHT
1310 JP MNCLS

1320PREFS: CALL CLS
1330 LD HL,PMENU0
1340 CALL PUTBNR
1350 LD HL,PMENU1
1360 CALL STRLN
1370 LD DE, 0200H
1380 CALL PUTSTR
1390 LD HL,PMENU2
1400 CALL STRLN
1410 LD DE, 0300H
1420 CALL PUTSTR
1430PREFS0: CALL WAITK
1440 CP 0
1450 JP Z,MAIN0
1460 CALL MX2KEY
1470 CP 'Q' ; quit
1480 JP Z,THEEND
1490 CP 'B' ; back
1500 JP Z,MNCLS
1510 CP 'S'
1520 JP Z,SETSF
1530 CP 'W'
1540 JP Z,SETBW
1550 JP PREFS0

1560SETSF: CALL CLS
1570 LD HL,SFMNU0
1580 CALL PUTBNR
1590 LD HL,SFMNU1
1600 CALL STRLN
1610 LD DE, 0100H
1620 CALL PUTSTR
1630 LD HL,SFMNU2
1640 CALL STRLN
1650 LD DE, 0200H
1660 CALL PUTSTR
1670 LD HL,SFMNU3
1680 CALL STRLN
1690 LD DE, 0300H
1700 CALL PUTSTR
1710 LD HL,SFMNU4
1720 CALL STRLN
1730 LD DE, 0500H
1740 CALL PUTSTR
1750SETSF0: CALL WAITK
1760 CP 0
1770 JP Z,MAIN0
1780 CALL MX2KEY
1790 CP 'Q' ; quit
1800 JP Z,THEEND
1810 CP 'B' ; back
1820 JP Z,PREFS
1830 CP '0'
1840 JP M,SETSF0
1850 CP '3'
1860 JP M,SETSF1
1870 CP '7'
1880 JP M,SETSF0
1890 CP ':'
1900 JP M,SETSF2
1910 JP SETSF0
1920SETSF1: LD HL,BUFFER
1930 PUSH AF
1940 LD A,'S'
1950 LD (HL),A
1960 INC HL
1970 LD A,'1'
1980 LD (HL),A
1990 INC HL
2000 POP AF
2010 LD (HL),A
2020 LD (SFVAL),A
2030SETSF3: INC HL
2040 XOR A
2050 LD (HL),A
2060 LD HL,BUFFER
2070 CALL PUTSR1
2080 JP PREFS
2090SETSF2: LD (SFVAL),A
2100 LD HL,BUFFER
2110 PUSH AF
2120 LD A,'S'
2130 LD (HL),A
2140 INC HL
2150 POP AF
2160 LD (HL),A
2170 INC HL
2180 JP SETSF3

2190SETBW: CALL CLS
2200 LD HL,BWMNU0
2210 CALL PUTBNR
2220 LD HL,BWMNU1
2230 CALL STRLN
2240 LD DE, 0100H
2250 CALL PUTSTR
2260 LD HL,BWMNU2
2270 CALL STRLN
2280 LD DE, 0200H
2290 CALL PUTSTR
2300 LD HL,BWMNU3
2310 CALL STRLN
2320 LD DE, 0300H
2330 CALL PUTSTR
2340 LD HL,BWMNU4
2350 CALL STRLN
2360 LD DE, 0500H
2370 CALL PUTSTR
2380SETBW0: CALL WAITK
2390 CP 0
2400 JP Z,MAIN0
2410 CALL MX2KEY
2420 CP 'Q' ; quit
2430 JP Z,THEEND
2440 CP 'B' ; back
2450 JP Z,PREFS
2460 CP '0'
2470 JP M,SETBW0
2480 CP ':'
2490 JP M,SETBW1
2500SETBW1: LD HL,BUFFER
2510 PUSH AF
2520 LD A,'B'
2530 LD (HL),A
2540 INC HL
2550 POP AF
2560 LD (HL),A
2570 LD (BWVAL),A
2580 INC HL
2590 XOR A
2600 LD (HL),A
2610 LD HL,BUFFER
2620 CALL PUTSR1
2630 JP PREFS

2640SHMBOX: CALL CLS
2650 LD HL,MNMBX0
2660 CALL PUTBNR
2670SHMBX1: CALL DSPMSG
2680SHMBX0: CALL WAITK
2690 CP 0
2700 JP Z,SHMBX0
2710 CP 3AH ; BS
2720 JP Z,MNCLS
2730 CP 1FH ; DOWN KEY
2740 JP Z,MBDOWN
2750 CP 20H ; UP KEY
2760 JP Z,MBUP
2770 CP 28H ; RETURN KEY
2780 JP Z,MBRETN
2790 CALL MX2KEY
2800 CP 'Q' ; quit
2810 JP Z,THEEND
2820 CP 'J' ; DOWN KEY
2830 JP Z,MBDOWN
2840 CP 'K' ; UP KEY
2850 JP Z,MBUP
2860 CP 'B' ; back
2870 JP Z,MNCLS
2880 JP SHMBX0

2890OFFSET: LD A,(POSY)
2900 LD HL,STOCK
2910 CP 0 ; IF 0 NO OFFSET
2920 JP Z,INC01
2930 LD B,A
2940 LD HL,0
2950 LD DE,128
2960INC00: ADD HL,DE
2970 DJNZ INC00
2980 LD DE,STOCK
2990 ADD HL,DE ; HL = STOCK+OFFSET
3000INC01: RET

3010DSPMSG: CALL OFFSET
3020 LD DE,0101H
3030 LD A,(MSGIDX) ; START INDEX
3040 LD B,4 ; 4 LINES
3050DSPMS0: PUSH BC
3060 PUSH AF
3070 PUSH HL
3080 PUSH DE
3090 LD DE,BUFFER
3100 LD BC,22
3110 LDIR
3120 LD B,22
3130 LD HL,BUFFER
3140DSPMS1: LD A,(HL)
3150 CP 31 ; BELOW SPACE?
3160 JP P,DSPMS2
3170 LD A,32
3180 LD (HL),A ; PUT A SPACE
3190DSPMS2: INC HL
3200 DJNZ DSPMS1
3210 LD HL,BUFFER
3220 LD B,22
3230 POP DE
3240 PUSH DE ; COORDS
3250 CALL PUTSTR
3260DSPMS4: POP DE
3270 POP HL
3280 LD BC,128
3290 ADD HL,BC
3300 LD A,D
3310 INC A
3320 LD D,A ; INC Y AXIS
3330 POP AF ; A=INDEX
3340 INC A
3350 CP 4 ; IF A>3 ROTATE BACK TO 0
3360 JP M,DSPMS3
3370 XOR A
3380 LD HL,STOCK
3390DSPMS3: POP BC
3400 DJNZ DSPMS0
3410 LD A,(POSY)
3420 INC A ; D STARTS ON LINE 1, NOT 0
3430 LD D,A
3440 LD E,1
3450 PUSH DE
3460 LD HL,BUFFER
3470 XOR A
3480 LD (HL),A
3490 INC HL
3500 LD B,131
3510 CALL LDPSTR
3520 LD HL,BUFFER
3530 LD B,132
3540DSPMS5: LD A,(HL)
3550 XOR 0FFH
3560 LD (HL),A
3570 INC HL
3580 DJNZ DSPMS5
3590 LD HL,BUFFER
3600 LD B,132
3610 POP DE
3620 CALL GPF
3630 RET
3640POSY:DB 0

3650MBDOWN: CALL MBDWN2
3660 JP SHMBX1
3670MBDWN2: LD A,(POSY)
3680 INC A
3690 LD (POSY),A
3700 CP 4
3710 JP M,MBDWN0
3720 XOR A
3730 LD (POSY),A
3740MBDWN0: LD B,A
3750 LD A,(NUMMSG)
3760 CP B
3770 JP M,MBDWN1
3780 RET
3790MBDWN1: XOR A
3800 LD (POSY),A
3810 RET

3820MBUP: CALL MBUP2
3830 JP SHMBX1
3840MBUP2: LD A,(POSY)
3850 CP 0
3860 JP NZ,MBUP0
3870 LD A,3
3880 JP MBUP1
3890MBUP0: DEC A
3900MBUP1: LD (POSY),A
3910 RET

3920MBRETN: CALL CLS
3930 CALL OFFSET
3940 LD DE,0
3950 LD B,128
3960 CALL PUTSTR
3970RTN00: CALL WAITK
3980 CP 0
3990 JP Z,RTN00
4000 CP 3AH ; BS
4010 JP Z,SHMBOX
4020 CP 28H ; RETURN KEY
4030 JP Z,SHMBOX
4040 CP 1FH ; DOWN KEY
4050 JP Z,RTN01
4060 CP 20H ; UP KEY
4070 JP Z,RTN02
4080 CALL MX2KEY
4090 CP 'Q' ; quit
4100 JP Z,THEEND
4110 CP ' '
4120 JP Z,SHMBOX
4130 CP 'B' ; back
4140 JP Z,SHMBOX
4040 CP 'J' ; DOWN KEY
4050 JP Z,RTN01
4060 CP 'K' ; UP KEY
4070 JP Z,RTN02
4150 JP RTN00
4160RTN01: CALL MBDWN2
4170 JP MBRETN
4180RTN02: CALL MBUP2
4190 JP MBRETN

4200BWEHT: PUSH BC
4210 CALL WEHT ; ~1 millisec
4220 POP BC
4230 DJNZ BWEHT
4240 RET

4250WEHT: LD B,241
4260WEHT0: NOP
4270 NOP
4280 NOP
4290 NOP
4300 NOP
4310 DJNZ WEHT0
4320 RET

4330PUTSR1: LD A,(HL)
4340 INC HL
4350 CP 0
4360 JP Z, PUTSR2
4370 OUT (72H),A
4380 CALL WEHT
4390 JP PUTSR1
4400PUTSR2: LD A,13
4410 OUT (72H),A
4420 LD A,10
4430 OUT (72H),A
4440 RET

4450PUTBNR: CALL STRLN
4460 LD A,24
4470 SUB B
4480 RRCA
4490 LD D,00H
4500 LD E,A
4510 CALL PUTSTR
4520 RET

4530NM2DEC: LD BC,-10000
4540 CALL NMDC1
4550 LD BC,-1000
4560 CALL NMDC1
4570 LD BC,-100
4580 CALL NMDC1
4590 LD C,-10
4600 CALL NMDC1
4610 LD C,B
4620NMDC1: LD A,-1
4630NMDC2: INC A
4640 ADD HL,BC
4650 JR C,NMDC2
4660 SBC HL,BC
4670 ADD A,48
4680 LD (DE),A
4690 INC DE
4700 RET

4710CLS: LD B,144
4720 LD DE,0
4730CLS0: LD A,32
4740 CALL RPTCHR
4750 RET
4760CLLN: LD B,24
4770 LD E,0
4780 JP CLS0

4790BYTE: PUSH AF
4800 AND 0F0H
4810 RRCA
4820 RRCA
4830 RRCA
4840 RRCA
4850 CALL NIBBLE
4860 INC HL
4870 POP AF
4880 AND 15
4890 CALL NIBBLE
4900 INC HL
4910 RET
4920NIBBLE: SUB 10
4930 JP M,ZERO9
4940 ADD A,7
4950ZERO9: ADD A,58
4960 LD (HL),A
4970 RET

4980STRLN: LD B,0
4990 PUSH HL ; preserve HL
5000STRLN0: LD A,(HL)
5010 CP 0
5020 JP Z,STRLN1
5030 INC HL
5040 INC B
5050 JP STRLN0
5060STRLN1: POP HL ; restore HL
5070 RET

5080MX2KEY: LD B,0
5090 LD C,A ; A IS KEY INDEX
5100 LD HL,MATRIX
5110 ADD HL,BC
5120 LD A,(HL)
5130 RET

5140PREPSR: LD A,2
5150 OUT (60H),A
5160 DEC A ; A=1
5170 OUT (74H),A
5180 XOR A ; A=0
5190 OUT (73H),A
5200 INC A ; A=1
5210 OUT (73H),A
5220 XOR A ; A=0
5230 OUT (73H),A
5240 LD A,0DH
5250 OUT (70H),A
5260 LD A,4EH
5270 OUT (71H),A
5280 LD A,10H
5290 OUT (71H),A
5300 XOR A ; A=0
5310 OUT (63H),A
5320 LD A,05H
5330 OUT (71H),A
5340 LD A,14H
5350 OUT (63H),A
5360 RET

5999GREET0: DB 13,10
5000GREET: DB '- LoRa Messenger -',0
5010MENUM0: DB '[p]ing [/]prefs [q]uit',0
5020MENUM1: DB '[m]box {'
5030MENUMB: DB 0,' msg}',0
5040MENUM2: DB 'SELECT MENU',0
5050RECVMS: DB 'receiving...',0
5060BUFFER: DEFS 132
5070 DB 0,0,0,0
5080ZOIGIN: DB 'Bye...',13,10,0
5090MATRIX: DB 0,0FFH
5100 DB 'QWERTYUASDFGHJKZXCVBNM,'
5110 DB 0FFH,0FFH,0FFH,0FFH,9,32,10,11,14,15 ; LEFT RIGHT UP DOWN
5120 DB 0FFH,'0.=+',13,'L;',0FFH,'123-'
5130 DB 0FFH,'IO',0FFH,'456*',0FFH,'P',8,0FFH,'789/)'
5140 DB 0FFH,0FFH,0FFH,0FFH,'(',0FFH,0FFH,0FFH,0FFH,0FFH,0FFH,0FFH,0FFH
5150 DB 0,12,0FFH
5160ROWNUM: DB 0
5170RCVSTR: DB 'Receiving...',13,10,0
5180BFPING: DB 'p',0
5190SPING: DB 'PING sent...',13,10,0
5200PMENU0: DB '- Preferences -',0
5210PMENU1: DB '[S]F  B[W]   [C]R',0
5220PMENU2: DB '[B]ack [Q]uit',0
5230BWMNU0: DB '- BW Prefs -',0
5240BWMNU1: DB '[0]  [1]  [2]  [3]  [4]',0
5250BWMNU2: DB '[5]  [6]  [7]  [8]  [9]',0
5260BWMNU3: DB ' [B]ack [Q]uit',0
5270BWMNU4: DB 'Current BW: '
5280BWVAL: DB '0',0
5290SFMNU0: DB '- SF Prefs -',0
5300SFMNU1: DB ' [7]  [8]  [9]',0
5310SFMNU2: DB '1[0] 1[1] 1[2]',0
5320SFMNU3: DB ' [B]ack [Q]uit',0
5330SFMNU4: DB 'Current SF: '
5340SFVAL: DB '0',0
5350MNMBX0: DB '- Msg Box -',0

5360DRAWMB: LD HL, MB0
5370 LD B, 12
5380 LD DE, 0016H
5390 CALL GPF
5400 LD HL, MB1
5410 LD B, 12
5420 LD DE,0116H
5430 CALL GPF
5440 RET

5450MB0: DB 003H, 0F3H, 063H, 00BH, 09BH, 03BH
5460 DB 03BH, 09BH, 00BH, 063H, 0F3H, 003H
5470MB1: DB 00CH, 00CH, 00CH, 00DH, 00DH, 00DH
5480 DB 00DH, 00DH, 00DH, 00CH, 00CH, 00CH

7000NUMMSG: DB 0FFH
7010MSGIDX: DB 0
7020STATUS: DB 0
7030MSGBUF: DB 0,0
7040STOCK: DEFS 128
7050 DEFS 128
7060 DEFS 128
7070 DEFS 128

