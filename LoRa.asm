10 ORG 100H
20 JP MAIN
30REGOUT EQU 0BD03H
40PUTSTR EQU 0BFF1H
50INKEY EQU 0BE53H
60PUTCHR EQU 0BE62H
70WAITK EQU 0BFCDH
80RPTCHR EQU 0BFEEH
90GPF EQU 0BFD0H
100LDPSTR EQU 0BD00H

110MSGNUM: DB 0
120MSGBUF: DB 0,0
130POSY: DB 0
140STARTY: DB 0
150LASTY: DB 0

160MAIN: CALL PREPSR
170 XOR A
180 LD (POSY),A
190 LD (STARTY),A
200 LD (LASTY),A
210 LD (MSGNUM),A
220 LD DE,8000H
230 LD (MSGBUF),DE

240MNCLS: CALL CLS
250 LD HL,GREET
260 CALL PUTBNR
270 LD HL,MENUM0
280 CALL STRLN
290 LD DE,0200H
300 CALL PUTSTR
310 LD HL,MENUM2
320 CALL STRLN
330 LD DE,0500H
340 CALL PUTSTR
350 LD A,(MSGNUM)
360 CP 0
370 JP Z,MAIN0
380 CALL DRAWMB
390 LD A,(MSGNUM)
400 ADD A,30H ; +48 ('0' ASCII)
410 LD (MENUMB),A
420 LD HL,MENUM1
430 CALL STRLN
440 LD DE,0300H
450 CALL PUTSTR

460MAIN0: IN A,(71H)
470 AND 2
480 JP NZ,RECV
490 CALL INKEY
500 CP 0
510 JP Z,MAIN0
520 CALL MX2KEY
530 CP 'Q' ; quit
540 JP Z,THEEND
550 CP 'P'
560 JP Z,PING
570 CP '/'
580 JP Z,PREFS
590 CP 'M'
600 JP Z,SHMBOX ; DEBUG
610 JP MAIN0

620THEEND: CALL CLS
630 CALL WAITK
640 LD HL,ZOIGIN
650 CALL STRLN
660 LD HL,ZOIGIN
670 LD DE,0
680 CALL PUTSTR
690 RET

700RECV: LD DE,0400H
710 LD HL,RCVSTR
720 CALL STRLN
730 CALL PUTSTR
740 LD HL,BUFFER
750RECV0: LD B,128
760 XOR A
770RECV1: LD (HL),A
780 INC HL
790 DJNZ RECV1 ; ZERO BUFFER
800 LD HL,BUFFER
810 LD B,127
820RECV4: IN A,(72H)
830 CP 1AH
840 JP Z,RECV5
850 LD (HL),A
860 INC HL
870RECV2: IN A,(71H)
880 AND 2
890 JP Z,RECV2
900 DJNZ RECV4
910RECV5: XOR A
920 LD (HL),A
930 CALL VBWEHT
940 CALL VBWEHT
950 CALL VBWEHT
960 CALL VBWEHT ; 1 SEC
970 LD DE,0400H
980 LD HL,DONE
990 CALL STRLN
1000 CALL PUTSTR
1010 CALL VBWEHT
1020 CALL VBWEHT
1030 CALL VBWEHT
1040 CALL VBWEHT ; 1 SEC
1050 LD A,(MSGNUM)
1060 INC A
1070 LD (MSGNUM),A ; WILL ROTATE NICELY TO 0
1080 LD HL,(MSGBUF)
1090 PUSH HL
1100 LD A,H
1110 LD HL,DBGS01
1120 CALL BYTE
1130 POP BC
1140 LD A,C
1150 LD HL,DBGS02
1160 CALL BYTE
1170 LD HL,DBGS00
1180 CALL STRLN
1190 LD DE,0400H
1200 CALL PUTSTR
1210 CALL VBWEHT
1220 CALL VBWEHT
1230 CALL VBWEHT
1240 CALL VBWEHT ; 1 SEC
1250 LD HL,(MSGBUF)
1260 LD DE,BUFFER
1270 LD B,128
1280 CALL RAMON
1290RECV7: LD A,(DE)
1300 LD (HL),A
1310 CP 0 ; NO NEED TO GO FURTHER
1320 JP Z,RECV8
1330 INC HL
1340 INC DE
1350 DJNZ RECV7
1360RECV8: CALL RAMOFF
1370 LD HL,(MSGBUF)
1380 LD BC,128
1390 ADD HL,BC
1400 LD A,(MSGNUM)
1410 CP 0
1420 JP NZ,RECV3
1430 LD HL,8000H
1440RECV3: LD (MSGBUF),HL
1450 PUSH HL
1460 LD A,H
1470 LD HL,DBGS04
1480 CALL BYTE
1490 POP BC
1500 LD A,C
1510 LD HL,DBGS05
1520 CALL BYTE
1530 LD HL,DBGS03
1540 CALL STRLN
1550 LD DE,0400H
1560 CALL PUTSTR
1570 CALL VBWEHT
1580 CALL VBWEHT
1590 CALL VBWEHT
1600 CALL VBWEHT ; 1 SEC
1610 JP MNCLS

1620PING: LD HL,BFPING
1630 CALL PUTSR1
1640 LD DE,0400H
1650 LD HL,SPING
1660 CALL STRLN
1670 LD DE,0400H
1680 CALL PUTSTR
1690 CALL VBWEHT
1700 CALL VBWEHT
1710 CALL VBWEHT
1720 CALL VBWEHT
1730 CALL VBWEHT
1740 CALL VBWEHT ; 1.5 SECS
1750 JP MNCLS

1760PREFS: CALL CLS
1770 LD HL,PMENU0
1780 CALL PUTBNR
1790 LD HL,PMENU1
1800 CALL STRLN
1810 LD DE, 0200H
1820 CALL PUTSTR
1830 LD HL,PMENU2
1840 CALL STRLN
1850 LD DE, 0300H
1860 CALL PUTSTR
1870PREFS0: CALL WAITK
1880 CP 0
1890 JP Z,MAIN0
1900 CALL MX2KEY
1910 CP 'Q' ; quit
1920 JP Z,THEEND
1930 CP 'B' ; back
1940 JP Z,MNCLS
1950 CP 'S'
1960 JP Z,SETSF
1970 CP 'W'
1980 JP Z,SETBW
1990 JP PREFS0

2000SETSF: CALL CLS
2010 LD HL,SFMNU0
2020 CALL PUTBNR
2030 LD HL,SFMNU1
2040 CALL STRLN
2050 LD DE, 0100H
2060 CALL PUTSTR
2070 LD HL,SFMNU2
2080 CALL STRLN
2090 LD DE, 0200H
2100 CALL PUTSTR
2110 LD HL,SFMNU3
2120 CALL STRLN
2130 LD DE, 0300H
2140 CALL PUTSTR
2150 LD HL,SFMNU4
2160 CALL STRLN
2170 LD DE, 0500H
2180 CALL PUTSTR
2190SETSF0: CALL WAITK
2200 CP 0
2210 JP Z,MAIN0
2220 CALL MX2KEY
2230 CP 'Q' ; quit
2240 JP Z,THEEND
2250 CP 'B' ; back
2260 JP Z,PREFS
2270 CP '0'
2280 JP M,SETSF0
2290 CP '3'
2300 JP M,SETSF1
2310 CP '7'
2320 JP M,SETSF0
2330 CP ':'
2340 JP M,SETSF2
2350 JP SETSF0
2360SETSF1: LD HL,BUFFER
2370 PUSH AF
2380 LD A,'S'
2390 LD (HL),A
2400 INC HL
2410 LD A,'1'
2420 LD (HL),A
2430 INC HL
2440 POP AF
2450 LD (HL),A
2460 LD (SFVAL),A
2470SETSF3: INC HL
2480 XOR A
2490 LD (HL),A
2500 LD HL,BUFFER
2510 CALL PUTSR1
2520 JP PREFS
2530SETSF2: LD (SFVAL),A
2540 LD HL,BUFFER
2550 PUSH AF
2560 LD A,'S'
2570 LD (HL),A
2580 INC HL
2590 POP AF
2600 LD (HL),A
2610 INC HL
2620 JP SETSF3

2630SETBW: CALL CLS
2640 LD HL,BWMNU0
2650 CALL PUTBNR
2660 LD HL,BWMNU1
2670 CALL STRLN
2680 LD DE, 0100H
2690 CALL PUTSTR
2700 LD HL,BWMNU2
2710 CALL STRLN
2720 LD DE, 0200H
2730 CALL PUTSTR
2740 LD HL,BWMNU3
2750 CALL STRLN
2760 LD DE, 0300H
2770 CALL PUTSTR
2780 LD HL,BWMNU4
2790 CALL STRLN
2800 LD DE, 0500H
2810 CALL PUTSTR
2820SETBW0: CALL WAITK
2830 CP 0
2840 JP Z,MAIN0
2850 CALL MX2KEY
2860 CP 'Q' ; quit
2870 JP Z,THEEND
2880 CP 'B' ; back
2890 JP Z,PREFS
2900 CP '0'
2910 JP M,SETBW0
2920 CP ':'
2930 JP M,SETBW1
2940SETBW1: LD HL,BUFFER
2950 PUSH AF
2960 LD A,'B'
2970 LD (HL),A
2980 INC HL
2990 POP AF
3000 LD (HL),A
3010 LD (BWVAL),A
3020 INC HL
3030 XOR A
3040 LD (HL),A
3050 LD HL,BUFFER
3060 CALL PUTSR1
3070 JP PREFS

3080SHMBOX: CALL CLS
3090 LD HL,MNMBX0
3100 CALL PUTBNR
3110SHMBX1: CALL DSPMSG
3120SHMBX0: CALL WAITK
3130 CP 0
3140 JP Z,SHMBX0
3150 CP 3AH ; BS
3160 JP Z,MNCLS
3170 CP 1FH ; DOWN KEY
3180 JP Z,MBDOWN
3190 CP 20H ; UP KEY
3200 JP Z,MBUP
3210 CP 28H ; RETURN KEY
3220 JP Z,MBRETN
3230 CALL MX2KEY
3240 CP 'Q' ; quit
3250 JP Z,THEEND
3260 CP 'J' ; DOWN KEY
3270 JP Z,MBDOWN
3280 CP 'K' ; UP KEY
3290 JP Z,MBUP
3300 CP 'B' ; back
3310 JP Z,MNCLS
3320 JP SHMBX0

3330DSPMSG: LD DE,0101H
3340 LD A,(MSGNUM)
3350 CP 4
3360 JP M,DSPMS6
3370 LD B,4
3380 JP DSPMS0
3390DSPMS6: LD B,A
3400DSPMS0: PUSH BC
3410 LD HL,(MSGBUF)
3420 PUSH HL
3430 PUSH DE
3440 LD DE,BUFFER
3450 LD B,22
3460 CALL RAMON
3470DSPMS1: LD A,(HL)
3480 CP 32 ; BELOW SPACE?
3490 JP M,DSPMS2
3500 LD (HL),A
3510 INC HL
3520DSPMS2: DJNZ DSPMS1
3530 LD HL,BUFFER
3540 LD B,22
3550 POP DE
3560 PUSH DE ; COORDS
3570 CALL PUTSTR
3580DSPMS4: POP DE
3590 POP HL
3600 LD BC,128
3610 ADD HL,BC
3620 LD A,D
3630 INC A
3640 LD D,A ; INC Y AXIS
3650DSPMS3: POP BC
3660 DJNZ DSPMS0
3670 CALL RAMOFF
3680 LD A,(POSY)
3690 INC A ; D STARTS ON LINE 1, NOT 0
3700 LD D,A
3710 LD E,1
3720 PUSH DE
3730 LD HL,BUFFER
3740 XOR A
3750 LD (HL),A
3760 INC HL
3770 LD B,131
3780 CALL LDPSTR
3790 LD HL,BUFFER
3800 LD B,132
3810DSPMS5: LD A,(HL)
3820 XOR 0FFH
3830 LD (HL),A
3840 INC HL
3850 DJNZ DSPMS5
3860 LD HL,BUFFER
3870 LD B,132
3880 POP DE
3890 CALL GPF
3900 RET

3910MBDOWN: CALL MBDWN2
3920 JP SHMBX1
3930MBDWN2: LD A,(POSY)
3940 INC A
3950 LD (POSY),A
3960 CP 4
3970 JP M,MBDWN0
3980 XOR A
3990 LD (POSY),A
4000MBDWN0: LD B,A
4010 LD A,(MSGNUM)
4020 CP B
4030 JP M,MBDWN1
4040 RET
4050MBDWN1: XOR A
4060 LD (POSY),A
4070 RET

4080MBUP: CALL MBUP2
4090 JP SHMBX1
4100MBUP2: LD A,(POSY)
4110 CP 0
4120 JP NZ,MBUP0
4130 LD A,3
4140 JP MBUP1
4150MBUP0: DEC A
4160MBUP1: LD (POSY),A
4170 RET

4180MBRETN: CALL CLS
4190 LD HL,(MSGBUF)
4200 LD A,(POSY)
4210 LD B,A
4220 LD A,(STARTY)
4230 ADD A,B
4240 JP Z,RTN03
4250 CALL RAMON
4260 LD B,A
4270 LD DE,128
4280RTN04: ADD HL,DE
4290 DJNZ RTN04 ; OFFSET
4300RTN03: LD DE,0
4310 LD B,128
4320 CALL PUTSTR
4330 CALL RAMOFF
4340RTN00: CALL WAITK
4350 CP 0
4360 JP Z,RTN00
4370 CP 3AH ; BS
4380 JP Z,SHMBOX
4390 CP 28H ; RETURN KEY
4400 JP Z,SHMBOX
4410 CP 1FH ; DOWN KEY
4420 JP Z,RTN01
4430 CP 20H ; UP KEY
4440 JP Z,RTN02
4450 CALL MX2KEY
4460 CP 'Q' ; quit
4470 JP Z,THEEND
4480 CP ' '
4490 JP Z,SHMBOX
4500 CP 'B' ; back
4510 JP Z,SHMBOX
4520 CP 'J' ; DOWN KEY
4530 JP Z,RTN01
4540 CP 'K' ; UP KEY
4550 JP Z,RTN02
4560 JP RTN00
4570RTN01: CALL MBDWN2
4580 JP MBRETN
4590RTN02: CALL MBUP2
4600 JP MBRETN

4610VBWEHT: LD B,250
4620BWEHT: PUSH BC
4630 CALL WEHT ; ~1 millisec
4640 POP BC
4650 DJNZ BWEHT
4660 RET

4670WEHT: LD B,241
4680WEHT0: NOP
4690 NOP
4700 NOP
4710 NOP
4720 NOP
4730 DJNZ WEHT0
4740 RET

4750PUTSR1: LD A,(HL)
4760 INC HL
4770 CP 0
4780 JP Z, PUTSR2
4790 OUT (72H),A
4800 CALL WEHT
4810 JP PUTSR1
4820PUTSR2: LD A,13
4830 OUT (72H),A
4840 LD A,10
4850 OUT (72H),A
4860 RET

4870PUTBNR: CALL STRLN
4880 LD A,24
4890 SUB B
4900 RRCA
4910 LD D,00H
4920 LD E,A
4930 CALL PUTSTR
4940 RET

4950NM2DEC: LD BC,-10000
4960 CALL NMDC1
4970 LD BC,-1000
4980 CALL NMDC1
4990 LD BC,-100
5000 CALL NMDC1
5010 LD C,-10
5020 CALL NMDC1
5030 LD C,B
5040NMDC1: LD A,-1
5050NMDC2: INC A
5060 ADD HL,BC
5070 JR C,NMDC2
5080 SBC HL,BC
5090 ADD A,48
5100 LD (DE),A
5110 INC DE
5120 RET

5130CLS: LD B,144
5140 LD DE,0
5150CLS0: LD A,32
5160 CALL RPTCHR
5170 RET
5180CLLN: LD B,24
5190 LD E,0
5200 JP CLS0

5210BYTE: PUSH AF
5220 AND 0F0H
5230 RRCA
5240 RRCA
5250 RRCA
5260 RRCA
5270 CALL NIBBLE
5280 INC HL
5290 POP AF
5300 AND 15
5310 CALL NIBBLE
5320 INC HL
5330 RET
5340NIBBLE: SUB 10
5350 JP M,ZERO9
5360 ADD A,7
5370ZERO9: ADD A,58
5380 LD (HL),A
5390 RET

5400STRLN: LD B,0
5410 PUSH HL ; preserve HL
5420STRLN0: LD A,(HL)
5430 CP 0
5440 JP Z,STRLN1
5450 INC HL
5460 INC B
5470 JP STRLN0
5480STRLN1: POP HL ; restore HL
5490 RET

5500MX2KEY: LD B,0
5510 LD C,A ; A IS KEY INDEX
5520 LD HL,MATRIX
5530 ADD HL,BC
5540 LD A,(HL)
5550 RET

5560PREPSR: LD A,2
5570 OUT (60H),A
5580 DEC A ; A=1
5590 OUT (74H),A
5600 XOR A ; A=0
5610 OUT (73H),A
5620 INC A ; A=1
5630 OUT (73H),A
5640 XOR A ; A=0
5650 OUT (73H),A
5660 LD A,0DH
5670 OUT (70H),A
5680 LD A,4EH
5690 OUT (71H),A
5700 LD A,10H
5710 OUT (71H),A
5720 XOR A ; A=0
5730 OUT (63H),A
5740 LD A,05H
5750 OUT (71H),A
5760 LD A,14H
5770 OUT (63H),A
5780 RET

6000GREET: DB '- LoRa Messenger -',0
6010MENUM0: DB '[p]ing [/]prefs [q]uit',0
6020MENUM1: DB '[m]box {'
6030MENUMB: DB 0,' msg}',0
6040MENUM2: DB 'SELECT MENU',0
6060BUFFER: DEFS 132
6070 DB 0,0,0,0
6080ZOIGIN: DB 'Bye...',13,10,0
6090MATRIX: DB 0,0FFH
6100 DB 'QWERTYUASDFGHJKZXCVBNM,'
6110 DB 0FFH,0FFH,0FFH,0FFH,9,32,10,11,14,15 ; LEFT RIGHT UP DOWN
6120 DB 0FFH,'0.=+',13,'L;',0FFH,'123-'
6130 DB 0FFH,'IO',0FFH,'456*',0FFH,'P',8,0FFH,'789/)'
6140 DB 0FFH,0FFH,0FFH,0FFH,'(',0FFH,0FFH,0FFH,0FFH,0FFH,0FFH,0FFH,0FFH
6150 DB 0,12,0FFH
6160ROWNUM: DB 0
6170RCVSTR: DB 'Receiving...',0
6175DONE:   DB 'Received msg...',0
6180BFPING: DB 'p',0
6190SPING: DB 'PING sent...',0
6200PMENU0: DB '- Preferences -',0
6210PMENU1: DB '[S]F  B[W]   [C]R',0
6220PMENU2: DB '[B]ack [Q]uit',0
6230BWMNU0: DB '- BW Prefs -',0
6240BWMNU1: DB '[0]  [1]  [2]  [3]  [4]',0
6250BWMNU2: DB '[5]  [6]  [7]  [8]  [9]',0
6260BWMNU3: DB ' [B]ack [Q]uit',0
6270BWMNU4: DB 'Current BW: '
6280BWVAL: DB '0',0
6290SFMNU0: DB '- SF Prefs -',0
6300SFMNU1: DB ' [7]  [8]  [9]',0
6310SFMNU2: DB '1[0] 1[1] 1[2]',0
6320SFMNU3: DB ' [B]ack [Q]uit',0
6330SFMNU4: DB 'Current SF: '
6340SFVAL: DB '0',0
6350MNMBX0: DB '- Msg Box -',0

6360DRAWMB: LD HL, MB0
6370 LD B, 12
6380 LD DE, 0016H
6390 CALL GPF
6400 LD HL, MB1
6410 LD B, 12
6420 LD DE,0116H
6430 CALL GPF
6440 RET

6450MB0: DB 003H, 0F3H, 063H, 00BH, 09BH, 03BH
6460 DB 03BH, 09BH, 00BH, 063H, 0F3H, 003H
6470MB1: DB 00CH, 00CH, 00CH, 00DH, 00DH, 00DH
6480 DB 00DH, 00DH, 00DH, 00CH, 00CH, 00CH

6500DBGS00: DB 'RECEIVED @ 0x'
6510DBGS01: DB 0,0
6520DBGS02: DB 0,0,0

6530DBGS03: DB 'Next address: 0x'
6540DBGS04: DB 0,0
6550DBGS05: DB 0,0,0

7000RAMON: ; DI
7010 IN A,(17H)
7020 LD (V19A),A
7030 LD A,0
7040 OUT (17H),A ; disable periph. interrupts
7050 IN A, (19H)
7060 LD (V19B),A
7070 LD B, 50H  ; /CEROM2=L,  BANK1=0, BANK0=1
7080 OR B
7090 OUT (19H),A ; enable ext. ram to 0x8000-0xC0000
7100 RET

7110RAMOFF: LD A,(V19B)
7120 OUT (19H),A
7130 LD A,(V19A)
7140 OUT (17H),A ; re-enable ROM
7150 ; EI
7160 RET
7170V19A: DB 0
7180V19B: DB 0

7190DEBUG: CALL CLS
7200 LD DE,BUFFER
7210 LD HL,8000H
7220 LD B,128
7230 CALL RAMON
7240DEBUG0: LD A,(HL)
7250 LD (DE),A
7260 CP 0
7270 JP Z,DEBUG1
7280 INC DE
7290 INC HL
7300 DJNZ DEBUG0
7310DEBUG1: CALL RAMOFF
7320 LD HL,BUFFER
7330 CALL STRLN
7340 LD DE,0
7350 CALL PUTSTR
7360 CALL WAITK
7370 ; CALL PREPSR
7390 JP MNCLS

